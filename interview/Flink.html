<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit inherit; background-repeat: inherit inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit inherit; background-repeat: inherit inherit; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; background-repeat: initial initial; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print { 
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; background-position: initial initial; background-repeat: initial initial; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; background-position: initial initial; background-repeat: initial initial; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); background-position: initial initial; background-repeat: initial initial; }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print { 
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) { 
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) { 
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571429rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ''; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ''; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ''; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: '−'; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}


 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>Flink</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><center><font size="60">Flink</font></center><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3"><a class="md-toc-inner" href="#1架构">1.架构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" href="#11flink运行架构">1.1Flink运行架构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n38"><a class="md-toc-inner" href="#12flink作业提交方式">1.2Flink作业提交方式</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n40"><a class="md-toc-inner" href="#121-yarn-session">1.2.1 Yarn session</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n54"><a class="md-toc-inner" href="#122-yarn-perjob">1.2.2 Yarn PerJob</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n66"><a class="md-toc-inner" href="#123-yarn-application">1.2.3 Yarn Application</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n68"><a class="md-toc-inner" href="#124-三种作业提交方式对比">1.2.4 三种作业提交方式对比</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n101"><a class="md-toc-inner" href="#125-公司怎么提交的实时任务有多少-job-managertask-manager">1.2.5 公司怎么提交的实时任务，有多少 Job Manager、Task Manager？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n106"><a class="md-toc-inner" href="#13-任务调度原理">1.3 任务调度原理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n108"><a class="md-toc-inner" href="#131-数据流图dataflow-graph）">1.3.1 数据流图（Dataflow Graph）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n119"><a class="md-toc-inner" href="#132-并行度parallelism）">1.3.2 并行度（Parallelism）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n120"><a class="md-toc-inner" href="#1321-什么是并行计算">1.3.2.1 什么是并行计算</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n125"><a class="md-toc-inner" href="#1322-并行子任务和并行度">1.3.2.2 并行子任务和并行度</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n129"><a class="md-toc-inner" href="#1323-并行度设置">1.3.2.3 并行度设置</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n142"><a class="md-toc-inner" href="#133-分区策略">1.3.3 分区策略</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n143"><a class="md-toc-inner" href="#1331-什么是partition">1.3.3.1 什么是Partition</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n146"><a class="md-toc-inner" href="#1332-分区策略">1.3.3.2 分区策略</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n185"><a class="md-toc-inner" href="#134-算子链operator-chain）">1.3.4 算子链（Operator Chain）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n186"><a class="md-toc-inner" href="#1341--算子间的数据传输">1.3.4.1  算子间的数据传输</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n197"><a class="md-toc-inner" href="#1342-合并算子链">1.3.4.2 合并算子链</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n201"><a class="md-toc-inner" href="#135-作业图jobgraph）与执行图executiongraph）">1.3.5 作业图（JobGraph）与执行图（ExecutionGraph）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n204"><a class="md-toc-inner" href="#136-任务tasks）和任务槽task-slots）">1.3.6 任务（Tasks）和任务槽（Task Slots）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n205"><a class="md-toc-inner" href="#1361-什么是任务槽">1.3.6.1 什么是任务槽</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n209"><a class="md-toc-inner" href="#1362-任务对任务槽的共享">1.3.6.2 任务对任务槽的共享</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n210"><a class="md-toc-inner" href="#1363-任务槽和并行度的关系">1.3.6.3 任务槽和并行度的关系</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n211"><a class="md-toc-inner" href="#14-问题">1.4 问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n212"><a class="md-toc-inner" href="#141-flink的一个作业是如何生成的">1.4.1 Flink的一个作业是如何生成的？</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n235"><a class="md-toc-inner" href="#2datastream-api">2.DataStream API</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n237"><a class="md-toc-inner" href="#3时间与窗口">3.时间与窗口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n238"><a class="md-toc-inner" href="#31-水位线">3.1 水位线</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n239"><a class="md-toc-inner" href="#311-flink中有几种时间语义">3.1.1 Flink中有几种时间语义</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n244"><a class="md-toc-inner" href="#312-什么是watermark">3.1.2 什么是watermark？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n249"><a class="md-toc-inner" href="#313-水位线是如何处理乱序数据的">3.1.3 水位线是如何处理乱序数据的？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n254"><a class="md-toc-inner" href="#314水位线的特性">3.1.4水位线的特性？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n268"><a class="md-toc-inner" href="#315-水位线是如何传递的">3.1.5 水位线是如何传递的？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n271"><a class="md-toc-inner" href="#316-如何生成水位线">3.1.6 如何生成水位线？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n287"><a class="md-toc-inner" href="#32-窗口">3.2 窗口</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n288"><a class="md-toc-inner" href="#321-窗口的理解">3.2.1 窗口的理解</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n291"><a class="md-toc-inner" href="#322-窗口分类都有哪些窗口">3.2.2 窗口分类，都有哪些窗口</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n314"><a class="md-toc-inner" href="#323-迟到的数据的处理">3.2.3 迟到的数据的处理</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n321"><a class="md-toc-inner" href="#324-水位线是如何传递的">3.2.4 水位线是如何传递的？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n324"><a class="md-toc-inner" href="#325-海量key去重">3.2.5 海量Key去重</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n330"><a class="md-toc-inner" href="#4多流转换">4.多流转换</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n331"><a class="md-toc-inner" href="#5-状态编程">5. 状态编程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n332"><a class="md-toc-inner" href="#51-状态机制">5.1 状态机制</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n333"><a class="md-toc-inner" href="#511-说一下flink状态机制">5.1.1 说一下Flink状态机制？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n335"><a class="md-toc-inner" href="#512-什么是状态">5.1.2 什么是状态？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n339"><a class="md-toc-inner" href="#513-有状态算子一般处理流程">5.1.3 有状态算子一般处理流程</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n349"><a class="md-toc-inner" href="#514-状态分类">5.1.4 状态分类</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n373"><a class="md-toc-inner" href="#6容错机制">6.容错机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n374"><a class="md-toc-inner" href="#61-checkpoint机制">6.1 Checkpoint机制</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n375"><a class="md-toc-inner" href="#611-什么是checkpoint">6.1.1 什么是checkpoint</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n377"><a class="md-toc-inner" href="#612-如何实现一个分布式系统的全局状态保留功能">6.1.2 如何实现一个分布式系统的全局状态保留功能</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n397"><a class="md-toc-inner" href="#613-flink中exactly-once和at-least-once-checkpoint的时候有什么区别">6.1.3 Flink中exactly once和at least once checkpoint的时候有什么区别</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n409"><a class="md-toc-inner" href="#614-checkpoint制作的snapshot快照存储方式有哪些">6.1.4 checkpoint制作的snapshot快照存储方式有哪些？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n420"><a class="md-toc-inner" href="#615-checkpoint相关配置">6.1.5 checkpoint相关配置</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n422"><a class="md-toc-inner" href="#616-从检查点恢复状态的具体步骤">6.1.6 从检查点恢复状态的具体步骤？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n436"><a class="md-toc-inner" href="#617-检查点算法---基于chandy-lamport算法的分布式快照">6.1.7 检查点算法—基于Chandy-Lamport算法的分布式快照**</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n439"><a class="md-toc-inner" href="#618-分布式快照算法---异步分界线快照asynchronous-barrier-snapshotting）">6.1.8 分布式快照算法—异步分界线快照（asynchronous barrier snapshotting）</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n441"><a class="md-toc-inner" href="#62-exactly-onec精确一次">6.2 exactly-onec精确一次</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n442"><a class="md-toc-inner" href="#621-状态一致性状态-exactly-once）">6.2.1 状态一致性（状态 Exactly-once）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n445"><a class="md-toc-inner" href="#622-端到端一致性端到端-exactly---once）">6.2.2 端到端一致性（端到端 Exactly - once）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n481"><a class="md-toc-inner" href="#623-如果下级存储不支持事务flink怎么保证exactly-once">6.2.3 如果下级存储不支持事务，Flink怎么保证exactly-once？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n484"><a class="md-toc-inner" href="#63-问题总结">6.3 问题总结</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n485"><a class="md-toc-inner" href="#631-flink作业在很多情况下有可能失败失败之后重新运行时是如何保证数据一致性的">6.3.1 Flink作业在很多情况下有可能失败，失败之后重新运行时，是如何保证数据一致性的？</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n496"><a class="md-toc-inner" href="#7flink-sql">7.Flink SQL</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n497"><a class="md-toc-inner" href="#71-api">7.1 API</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n499"><a class="md-toc-inner" href="#711-程序架构">7.1.1 程序架构</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n503"><a class="md-toc-inner" href="#712-表环境tableenvironment">7.1.2 表环境TableEnvironment</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n519"><a class="md-toc-inner" href="#713-创建表">7.1.3 创建表</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n534"><a class="md-toc-inner" href="#714-表和流转换">7.1.4 表和流转换</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n562"><a class="md-toc-inner" href="#715-支持的数据类型">7.1.5 支持的数据类型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n581"><a class="md-toc-inner" href="#72-流处理中的表">7.2 流处理中的表</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n582"><a class="md-toc-inner" href="#73-时间属性和窗口">7.3 时间属性和窗口</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n583"><a class="md-toc-inner" href="#731-时间">7.3.1 时间</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n584"><a class="md-toc-inner" href="#732-窗口">7.3.2 窗口</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n585"><a class="md-toc-inner" href="#7321-窗口表值函数windowing-tvfs新版本）">7.3.2.1 窗口表值函数（Windowing TVFs，新版本）</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n606"><a class="md-toc-inner" href="#74-聚合">7.4 聚合</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n607"><a class="md-toc-inner" href="#741-窗口聚合">7.4.1 窗口聚合</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n611"><a class="md-toc-inner" href="#742-开窗聚合">7.4.2 开窗聚合</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n618"><a class="md-toc-inner" href="#743-窗口topn">7.4.3 窗口TopN</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n621"><a class="md-toc-inner" href="#75-join">7.5 Join</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n623"><a class="md-toc-inner" href="#751-双流joinregular-join）">7.5.1 双流Join（Regular Join）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n636"><a class="md-toc-inner" href="#752-window-join">7.5.2 Window Join</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n641"><a class="md-toc-inner" href="#752-区间joininterval-join）">7.5.2 区间Join（Interval Join）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n642"><a class="md-toc-inner" href="#753-时态表-jointemproal-join）">7.5.3 时态表 Join（Temproal Join）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n643"><a class="md-toc-inner" href="#754-自定义函数-udtf">7.5.4 自定义函数 UDTF</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n645"><a class="md-toc-inner" href="#8压测与监控">8.压测与监控</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n646"><a class="md-toc-inner" href="#81-flink反压机制">8.1 Flink反压机制</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n647"><a class="md-toc-inner" href="#811-flink数据交换">8.1.1 Flink数据交换</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n677"><a class="md-toc-inner" href="#812-flink的credit-based反压机制">8.1.2 Flink的Credit-based反压机制</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n694"><a class="md-toc-inner" href="#81-怎么做压力测试和监控">8.1 怎么做压力测试和监控？</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n703"><a class="md-toc-inner" href="#9-实时数仓">9. 实时数仓</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n704"><a class="md-toc-inner" href="#91-事实数仓案例">9.1 事实数仓案例</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n705"><a class="md-toc-inner" href="#911-菜鸟仓配实时数据仓库">9.1.1 菜鸟仓配实时数据仓库</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n736"><a class="md-toc-inner" href="#10-性能优化">10. 性能优化</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n737"><a class="md-toc-inner" href="#101-数据倾斜">10.1 数据倾斜</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n738"><a class="md-toc-inner" href="#1011-原理">10.1.1 原理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n749"><a class="md-toc-inner" href="#1012-数据倾斜的影响">10.1.2 数据倾斜的影响</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n763"><a class="md-toc-inner" href="#1013-如何定位数据倾斜">10.1.3 如何定位数据倾斜</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n770"><a class="md-toc-inner" href="#1014-解决方法">10.1.4 解决方法</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n772"><a class="md-toc-inner" href="#10141-keyby-之前发生数据倾斜">10.1.4.1 keyBy 之前发生数据倾斜</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n780"><a class="md-toc-inner" href="#10142-keyby后的聚会操作存在数据倾斜">10.1.4.2 keyBy后的聚会操作存在数据倾斜</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n789"><a class="md-toc-inner" href="#10143keyby后的窗口聚合操作存在数据倾斜">10.1.4.3keyBy后的窗口聚合操作存在数据倾斜</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n802"><a class="md-toc-inner" href="#102-并行度设置">10.2 并行度设置</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n803"><a class="md-toc-inner" href="#1021-全局并行度计算">10.2.1 全局并行度计算</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n810"><a class="md-toc-inner" href="#103-flink-sql优化">10.3 Flink SQL优化</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n811"><a class="md-toc-inner" href="#1031-设置空闲状态保留时间">10.3.1 设置空闲状态保留时间</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n821"><a class="md-toc-inner" href="#1032-开启minibatch">10.3.2 开启MiniBatch</a></span></p></div><h2 id='1架构'><span>1.架构</span></h2><h3 id='11flink运行架构'><span>1.1Flink运行架构</span></h3><p>&nbsp;</p><p><img src="../image/interview/Flink/运行架构.svg" alt="运行架构" style="zoom:80%;" /></p><p><img src="../image/interview/Flink/运行架构-中文.png" alt="运行架构-中文" style="zoom:50%;" /></p><p><span>简单来说：当Flink启动集群后，首先会启动一个JobManager和一个或多个TaskManager。由Client提交任务给JobManager，JobManager再调度任务到各个TaskManager去执行，然后TaskManager将心跳和统计信息汇报给JobManger。TaskManager之间以流的形式进行数据的传输。</span></p><ul><li><p><span>Client（任务提交客户端）</span></p><p><span>是Flink作业任务提交客户端，主要将批处理或流处理应用程序编译为数据流图（JobGraph），然后提交给JobManager。</span></p><p><span>Client不是运行时和程序执行的一部分，而是用于准备数据流并将其发给JobManager。之后，客户端可以断开连接（分离模式），或保持连接来接收进程报告（附加模式）。</span></p></li><li><p><span>JobManager（任务协调者）</span></p><p><span>JobManger具有许多与协调Flink应用程序的分布式执行有关的职责：它决定何时调度下一个task（或一组task）、对完成的task或执行失败做出反应、协调checkpoint、协调从失败中恢复等。这个进程由三个不同的组件组成：</span></p><ul><li><p><span>ResourceManger</span></p><p><span>ResourceManger负责Flink集群中的资源提供、回收、分配—它管理task slots，这是Flink集群中资源调度单位。ResourceManager可以分配TaskManager中的slots，新启动的TaskManager，需要向ResourceManager进行注册，之后它里面的资源才能服务与作业的请求。</span></p><ul><li><p><span>SlotManager</span></p><p><span>管理着Slot状态，这些Slot状态是通过TaskExecutor到ResourceManger之间的心跳来进行更新的，在心跳信息中包含了TaskExecutor中所有的Slot状态。</span></p><p><span>当JobManger调度一个任务时候，会向ResourceManger发起Slot请求。收到请求的ResourceManger会转交给SlotManager，SlotManager会去检查它里面的可用的Slot有没有符合请求条件的。如果有的话，它就会向相应的TaskExecutor发起Slot申请。如果请求成功，TaskExecutor会主动想的向JobManster offer 这个slot。</span></p></li></ul></li><li><p><span>Dispatcher</span></p><p><span>Dispatcher提供一个Rest接口，用来提交Flink应用程序执行，并为每个提交的作业启动一个新的JobMaster。它还运行Flink WebUI来提供作业执行信息。</span></p></li><li><p><span>JobMaster</span></p><p><span>JobMaster负责管理单个JobGraph的执行，Flink集群中可以同时运行多个作业，每个作业都有自己的JobMaster。</span></p></li></ul><p><span>始终至少有一个JobManager。高可用（HA）设置中可能有多个JobManager，其中一个始终是leader，其他的则是standby。</span></p></li><li><p><span>TaskManager</span></p><p><span>TaskManager（也称为worker）执行作业流的task，并且缓存和交换数据流。</span></p><p><span>必须始终至少有一个TaskManger。在TaskManger中资源调度的最小单位是task slot。TaskManger中task slot的数量表示并发处理task的数量。请注意一个task slot中可以执行多个算子。</span></p><p><span>Slot是资源调度的最小单位，slot的数量限制了TaskManager能够并行的任务数量</span></p></li></ul><h3 id='12flink作业提交方式'><span>1.2Flink作业提交方式</span></h3><p><span>		</span><span>Flink作业提交方式主要有三种：Yarn session、Yarn PerJob、Yarn Application</span></p><h5 id='121-yarn-session'><span>1.2.1 Yarn session</span></h5><p><span>		</span><span>会话模式需要先启动新的Yarn Session集群：通过Yarn Client向yarn提交Flink创建集群的申请，Yarn分配资源，在申请的yarn container中初始化并启动JobManager进程，初始化Dispatcher、ResourceManager，启动相关的RPC服务，等待Client通过Rest接口提交作业。</span></p><p><img src="../image/interview/Flink/yarn session.png" referrerpolicy="no-referrer" alt="image-20221208172435287"></p><p><strong><span>作业提交：</span></strong></p><p><span>（1）Client通过Rest向分发器Dispatcher提交JobGraph</span></p><p><span>（2）Dispatcher是Rest接口，不负责实际的调度、执行方面的工作，当收到JobGraph后，为作业创建一个JobMaster，将工作交给JobMaster（负责作业调度、管理作业和Task的生命周期）</span></p><p><strong><span>作业调度执行：</span></strong></p><p><span>（3）JobMaster向资源管理器请求资源（slots）</span></p><p><span>（4）资源管理器向Yarn ResourceManager请求container资源</span></p><p><span>（5）Yarn启动新的TaskManager容器</span></p><p><span>（6）TaskManager启动之后，向Flink的资源管理器注册自己的可用slots。</span></p><p><span>（7）资源管理器通知TaskManager为新的作业提供slots</span></p><p><span>（8）TaskManager连接到对应的JobManager，提供slots</span></p><p><span>（9）JobMaster将需要执行的任务分发给TaskManager，执行任务。</span></p><h5 id='122-yarn-perjob'><span>1.2.2 Yarn PerJob</span></h5><p><img src="../image/interview/Flink/作业提交流程.png" referrerpolicy="no-referrer" alt="image-20221107005917538"></p><p><span>在作业模式下，Flink集群不会预先启动，而是在提交作业时，才启动新的JobManager。</span></p><p><span>（1）客户端将作业提交给Yarn的资源管理器，这一步会同时将Flink的Jar包和配置上传到HDFS，以便后续启动Flink相关组件的容器</span></p><p><span>（2）Yarn资源管理器分配Container资源，启动Flink JobManager，并将作业提交给JobMaster</span></p><p><span>（3）JobMaster向资源管理器请求资源（slots）</span></p><p><span>（4）资源管理器向YARN的资源管理器请求container资源。</span></p><p><span>（5）YARN 启动新的TaskManager容器</span></p><p><span>（6）TaskManager启动之后，向Flink的资源管理器注册自己的可用任务槽。</span></p><p><span>（7）资源管理器通知TaskManager为新的作业提供slots。</span></p><p><span>（8）TaskManager连接到对应的JobMaster，提供 slots。</span></p><p><span>（9）JobMaster 将需要执行的任务分发给 TaskManager，执行任务。</span></p><h5 id='123-yarn-application'><span>1.2.3 Yarn Application</span></h5><p><span>		</span><span>Application Mode与Per-job Mode类似，主要解决Per-job Mode的不足，初始提交给Yarn 资源管理器的不再是具体的作业，而是整个应用，一个应用中可能包含多个作业。另外client是在JobManager上执行的，可以避免宽带、CPU的热点问题。</span></p><h5 id='124-三种作业提交方式对比'><span>1.2.4 三种作业提交方式对比</span></h5><ul><li><p><span>session mode</span></p><p><span>JobManager和TaskManager共享</span></p><ul><li><p><span>优点：集群资源仅分配一次，充分利用资源，程序App启动较快</span></p></li><li><p><span>缺点：可能会连锁式的重启，JobManager负载大</span></p></li><li><p><span>启动命令</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./bin/yarn-session.sh <span class="cm-attribute">-n</span> <span class="cm-number">4</span> <span class="cm-attribute">-tm</span> <span class="cm-number">8192</span> <span class="cm-attribute">-s</span> <span class="cm-number">8</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./bin/flink run <span class="cm-attribute">-c</span> com.demo.wangzhiwu.WordCount <span class="cm-def">$DEMO_DIR</span>/target/flink-demo-1.0.SNAPSHOT.jar <span class="cm-attribute">--port</span> <span class="cm-number">9000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="height: 88px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre></li></ul></li><li><p><span>per-job mode</span></p><p><span>单独Job独享JobManager和TaskManager</span></p><ul><li><p><span>优点：资源隔离，粒度更细，方便管理单个job</span></p></li><li><p><span>缺点：当某个机器上有多个client时，会有较高的网络负载（下载jar、传输jar）以及消费大量的CPU来执行main方法</span></p></li><li><p><span>运行命令</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./bin/flink run -m yarn-cluster -c com.demo.wangzhiwu.WordCount -ys 2 ./examples/batch/WordCount.jar --input hdfs://user/hadoop/input.txt --output hdfs://user/hadoop/output.txt</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="height: 110px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p></li></ul></li><li><p><span>application mode</span></p><p><span>主要解决Pre-job mode的不足</span></p><ul><li><span>运行命令</span></li></ul><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./bin/flink run-application -t yarn-application \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-Djobmanager.memory.process.size=1024m \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-Dtaskmanager.memory.process.size=1024m \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">-Dyarn.application.name="MyFlink" \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./examples/batch/AAA.jar --output hdfs://node01:8020/output_51</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="height: 110px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre></li></ul><h5 id='125-公司怎么提交的实时任务有多少-job-managertask-manager'><span>1.2.5 公司怎么提交的实时任务，有多少 Job Manager、Task Manager？</span></h5><p><span>		</span><span>我们使用 yarn pre-job 模式提交任务，该方式特点：每次提交都会创 建一个新的 Flink 集群，为每一个 job 提供资源，任务之间互相独立，互不影响， 方便管理。任务执行完成之后创建的集群也会消失。线上命令脚本如下：</span></p><p><span>bin/yarn-session.sh -n 7 -s 8 -jm 3072 -tm 32768 -qu root.. -nm - -d</span></p><p><span>其中申请7个taskManager，每个8核，每个taskmanager有32768M内存。</span></p><p><span>对于yarn模式，yarn在Job Mananger 故障会自动进行重启，所以只需要一个，我们配置的最大重启次数是10次</span><span>	</span></p><h3 id='13-任务调度原理'><span>1.3 任务调度原理</span></h3><p><span>		</span><span>一个具体的作业，是怎样从我们编写的代码，转换成TaskManager可以执行的任务呢？JobManager收到提交的作业，又是怎样确定总共有多少任务、需要多少资源呢？</span></p><h4 id='131-数据流图dataflow-graph）'><span>1.3.1 数据流图（Dataflow Graph）</span></h4><p><span>		</span><span>编写的程序结构，其实就是定义一连串的处理操作，每个数据输入之后都会依次调用每一步计算。在Flink代码中，定义的每一个处理转换操作都叫做“算子”（Operator）。</span></p><p><span>		</span><span>Flink程序可以归纳为3部分构成：</span></p><ul><li><span>Source：表示“源算子”，负责读取数据源。</span></li><li><span>Transformation：表示“转换算子”，利用各种算子进行处理加工。</span></li><li><span>Sink：表示“下沉算子”，负责数据的输出</span></li></ul><p><span>		</span><span>在运行时，</span><strong><span>Flink程序会被映射成所有算子按照逻辑顺序连接在一起的一张图，这被称为“逻辑数据流”（logical dataflow）或者叫“数据流图”（dataflow graph）。</span></strong><span>数据流图类似于任意的有向无环图（DAG），这一点与spark等其他框架是一致的。</span></p><h4 id='132-并行度parallelism）'><span>1.3.2 并行度（Parallelism）</span></h4><h5 id='1321-什么是并行计算'><span>1.3.2.1 什么是并行计算</span></h5><p><span>		</span><span>Spark是根据程序生成DAG划分阶段（stage），进而分配任务的。对于Flink流式引擎，没有必要划分stage。因为数据是连续不断到来的，完全可以按照数据流图建立一个“流水线”，前一个操作处理完成，就发往处理下一步操作的节点。</span></p><p><span>		</span><span>Spark具有MapReduce架构思想是“数据不懂代码动”，Flink类似“代码不动数据流动”</span></p><p><span>		</span><span>任务并行：将不同的算子操作任务，分配到不同的节点上执行，对任务做了分摊，实现了并行处理。但这种“并行”其实并不彻底，因为算子之间是有执行顺序的，对一条数据来说必须依次执行；而一个算子在同一时刻只能处理一个数据。</span></p><p><span>		</span><span>数据并行：多条数据同时到来，可以同时读入，同时在不同节点执行flatMap操作。</span></p><h5 id='1322-并行子任务和并行度'><span>1.3.2.2 并行子任务和并行度</span></h5><p><span>		</span><span>怎么实现数据并行呢？把一个算子操作，“复制”多份到多个节点，数据来了之后就可以到其中任意一个执行。一个算子任务就被拆分成了多个并行的“子任务”（subtasks）。</span></p><p><img src="../image/interview/Flink/并行数据流.png" referrerpolicy="no-referrer" alt="image-20221212185651896"></p><p><span>		</span><strong><span>一个特定算子的子任务（subtask）的个数被称之为其并行度（parallelism）。</span></strong><span> 它需要多个分区（stream partition）来配合并执行任务</span></p><h5 id='1323-并行度设置'><span>1.3.2.3 并行度设置</span></h5><ul><li><p><span>代码中设置</span></p><p><span>setParallelism()方法</span></p></li><li><p><span>提交应用时设置</span></p><p><span>bin/flink run -p 2 使用-p参数来指定并行度</span></p></li><li><p><span>配置文件中设置</span></p><p><span>flink-conf.yaml更改默认并行度：parallelism.default:2</span></p><p><span>在开发环境中，没有配置文件，默认并行度是当前机器CPU核心数</span></p></li></ul><p><span>并行度设置方法优先级：代码中设置 &gt; 提交应用时设置 &gt; 配置文件中设置</span></p><h4 id='133-分区策略'><span>1.3.3 分区策略</span></h4><h5 id='1331-什么是partition'><span>1.3.3.1 什么是Partition</span></h5><p><span>		</span><span>在分布式存储中，Partition分区的概念是把数据集切分成块，每一块数据存储在不同的机器上。</span></p><p><span>		</span><span>对于分布式计算引擎，是将数据切分，交给位于不同物理节点上的Task计算。</span><strong><span>Flink中，就是把一个作业切分成子任务Task，将不同的数据交给不同的Task计算。</span></strong></p><h5 id='1332-分区策略'><span>1.3.3.2 分区策略</span></h5><p><span>		</span><span>目前Flink支持8中分区策略实现：</span></p><ol start='' ><li><p><span>GlobalPartitioner</span></p><p><span>数据会被分发到下游算子的第一个实例中进行处理</span></p><p><span>使用场景：并行度降为1</span></p></li><li><p><span>ForwardPartitioner</span></p><p><span>用于在用一个Operator Chain中上下游算子之间的数据转发，实际上数据是直接传递给下游的，要求上下游并行度一样。</span></p><p><span>使用场景：一对一的数据分发，map、flatMap、filter等都是这种分区策略</span></p></li><li><p><span>ShufflePartitioner</span></p><p><span>随机将元素进行分区，可以确保下游的Task能够均匀地获得数据</span></p><p><span>dataStream.shuffle()</span></p><p><span>使用场景：增大分区、提高并行度，解决数据倾斜</span></p></li><li><p><span>RebalancePartitioner</span></p><p><span>以Round-robin（轮询调度算法）的方式为每个元素分配分区，确保下游的Task可以均匀地获得数据，避免数据倾斜。</span></p><p><span>dataStream.rebalance()</span></p><p><span>使用场景：增大分区、提高并行度，解决数据倾斜</span></p></li><li><p><span>RescalePartitioner</span></p><p><span>根据上下游Task的数量进行分区，使用Round-robin寻找下游的一个task进行数据分区。</span></p><p><span>如果上游有2 Source，下游有6个Map，那么每个 Source 会分配3个固定的下游Map，不会向未分配给自己的分区写人数据。这一点与ShufflePartitioner 和RebalancePartitioner 不同， 后两者会写入下游所有的分区。</span></p><p><span>dataStream.rescale()</span></p><p><span>使用场景：减少分区，防止发生大量的网络传输 不会发生全量的重分区</span></p></li><li><p><span>BroadcastPartitioner</span></p><p><span>将记录广播给所有分区，即有N个分区，就把数据复制N份，每个分区1份</span></p><p><span>dataStream.broadcast()</span></p><p><span>使用场景：需要使用映射表、并且映射表会经常发生变动的场景</span></p></li><li><p><span>KeyGroupStreamPartitioner</span></p><p><span>在API层面，KeyGroupStreamPartitioner应用在KeyedStream上，生成一个新的KeyedStream。</span></p><p><span>KeyedStream根据keyGroup索引编号进行分区，会将数据按照key的Hash值输出到下游算子实例中。该分区器不是提供给用户使用的。</span></p></li><li><p><span>CustomPartitioner</span></p><p><span>用户自定义分区器。需要用户自己实现Partitioner接口，来定义自己的分区逻辑。</span></p></li></ol><h4 id='134-算子链operator-chain）'><span>1.3.4 算子链（Operator Chain）</span></h4><h5 id='1341--算子间的数据传输'><span>1.3.4.1  算子间的数据传输</span></h5><p><img src="../image/interview/Flink/算子间的数据传输.png" referrerpolicy="no-referrer" alt="image-20221212224301342"></p><p><span>		</span><span>如上图所示，一个数据流在算子之间传输数据的形式可以是一对一（one-to-one）的直通（forwarding）模式，也可以是打乱的重分区（redistribute）模式</span></p><ul><li><p><span>一对一（one-to-one，forwarding）</span></p><p><span>数据流维护着分区以及元素的顺序，这种one-to-one的对应关系，类似于spark中的窄依赖。</span></p></li><li><p><span>重分区（redistributing）</span><span>	</span></p><p><span>数据流的分区发生改变，每一个算子的子任务，会根据数据传输的策略，把数据发送到不同的下游目标任务。</span></p><p><span>例如：keyBy()是分组操作，本质上基于键（key）的哈希值（hashCode）进行了重分区。类似于spark中的shuffle。类似于spark中宽依赖。</span></p></li></ul><h5 id='1342-合并算子链'><span>1.3.4.2 合并算子链</span></h5><p><span>		</span><span>在flink中，并行度相同的一对一（one to one）算子操作，可以直接链接在一起形成一个“大”的任务（task），原来的算子成为了task中的一部分。每个task会被一个线程执行，这样的技术被称为“算子链”（Operator Chain）。</span></p><p><img src="../image/interview/Flink/合并算子链.png" referrerpolicy="no-referrer" alt="image-20221212225717377"></p><p><span>		</span><span>Flink为什么要有算子链这样一个设计呢？因为降算子链接成task是非常有效的优化：可以减少线程之间的切换和基于缓存区的数据交换，减少延迟的同时提升吞吐量。</span></p><h4 id='135-作业图jobgraph）与执行图executiongraph）'><span>1.3.5 作业图（JobGraph）与执行图（ExecutionGraph）</span></h4><p><span>		</span><span>梳理总结一下由代码生成任务的过程，包括需要考虑并行子任务的分配、数据在任务间的传输，以及合并算子链的优化。</span></p><p><span>		</span><span>代码  —&gt; 逻辑流图（StreamGraph）  —&gt; 作业图（JobGraph）  —&gt;执行图（ExecutionGraph）  —&gt;物理图（Physical Graph）</span></p><h4 id='136-任务tasks）和任务槽task-slots）'><span>1.3.6 任务（Tasks）和任务槽（Task Slots）</span></h4><h5 id='1361-什么是任务槽'><span>1.3.6.1 什么是任务槽</span></h5><p><span>		</span><span>任务槽（task slot）是TaskManager拥有计算资源的一个固定大小的子集，这些资源就是用来独立执行一个子任务的。</span></p><p><span>		</span><span>可以通过集群的配置文件来设定TaskManager的slot数量: taskmanager.numberOfTaskSlots: 8。通过调整slot数量，可以控制子任务之间的隔离级别。</span></p><p><span>		</span><span>slot目前仅仅用来隔离内存，不会涉及CPU隔离。在具体应用时，可以将slot数量配置为机器的CPU核心数，尽量避免不同任务之间对CPU的竞争。</span></p><h5 id='1362-任务对任务槽的共享'><span>1.3.6.2 任务对任务槽的共享</span></h5><h5 id='1363-任务槽和并行度的关系'><span>1.3.6.3 任务槽和并行度的关系</span></h5><h3 id='14-问题'><span>1.4 问题</span></h3><h4 id='141-flink的一个作业是如何生成的'><span>1.4.1 Flink的一个作业是如何生成的？</span></h4><p><span>		</span><span>理解作业是如何在Flink中表达的？</span></p><p><img src="../image/interview/Flink/作业生成流程.png" alt="作业生成流程" style="zoom:50%;" /></p><ol start='' ><li><p><span>Client将作业code生成StreamGraph，描述了算子和算子之间逻辑的拓扑关系</span></p></li><li><p><span>Client将StreamGraph转换为JobGrahp：Operator chain（又称JobVertex）</span></p><ul><li><span>将并不涉及到shuffle的算子进行合并</span></li><li><span>对于同一个operator chain里面的多个算子，会在同一个task中执行</span></li><li><span>对于不在同一个operator chain里的算子，会在不同的task中执行</span></li></ul></li><li><p><span>Client中的ClusterClient将JobGraph提交给Dispatcher，Dispatcher根据JobGraph创建相应的JobMaster并运行起来</span></p></li><li><p><span>JobMaster将JobGraph转换为ExecutionGraph</span></p><p><span>逻辑图JobVertex中的一个节点，会对应着并发数个执行节点ExecutionVertex，节点对应着一个个任务，这些任务最后会作为实体部署到Worker节点上，并执行实际的数据处理业务逻辑。</span></p></li><li><p><span>JobMaster将ExecutionGraph转换为物理执行计划（可执行）</span></p></li></ol><p><span>		</span></p><h2 id='2datastream-api'><span>2.DataStream API</span></h2><p>&nbsp;</p><h2 id='3时间与窗口'><span>3.时间与窗口</span></h2><h3 id='31-水位线'><span>3.1 水位线</span></h3><h5 id='311-flink中有几种时间语义'><span>3.1.1 Flink中有几种时间语义</span></h5><p><span>（1）处理时间（Processing Time）</span></p><p><span>		</span><span>处理时间指执行处理操作的机器系统时间</span></p><p><span>（2）事件事件（Event Time）</span></p><p><span>		</span><span>事件时间，是指每个事件在对应设备上发生的事件，也就是数据生成的时间</span></p><h5 id='312-什么是watermark'><span>3.1.2 什么是watermark？</span></h5><p><span>		</span><span>在事件时间语义下，我们不依赖系统时间，而是基于数据自带的时间戳去定义一个时钟，用来表示当前时间的进展。并且这个时钟以数据的形式传递出去，告诉下游任务当前时间的进展；而且这个时钟的传递不会因为窗口聚合之类的运算而停滞。</span></p><p><span>		</span><span>做法是在数据流中加入一个时钟标记，记录当前事件时间；这个标记可以直接广播到下游，当下游任务收到这个标记，就可以更新自己的时钟了。</span></p><p><span>		</span><span>在Flink中，用来衡量事件事件（Event Time）进展的标记，被称作“水位线”Watermark</span></p><p><span>		</span><span>具体实现，</span><strong><span>水位线可以看作一条特殊的数据记录，它是插入到数据流中的一个标记点，主要内容就是一个时间戳，用来指示当前的事件时间。而它插入流中的位置，就应该是在某个数据到来之后；这样就可以从这个数据中提取时间戳，作为当前水位线的时间戳了。</span></strong></p><h5 id='313-水位线是如何处理乱序数据的'><span>3.1.3 水位线是如何处理乱序数据的？</span></h5><p><span>		</span><span>乱序数据：在分布式系统中，数据在节点间传输，会因为网络传输延迟的不确定性，导致顺序发生改变。</span></p><p><span>		</span><span>简单处理：每来一个数据就提取它的时间戳、插入一个水位线，但是</span><strong><span>乱序数据</span></strong><span>，可能新的时间戳比之前的还小，那么插入新的水位线时，先判断一下时间戳是否比之前的大，否则就不再生成新的水位线。考虑到</span><strong><span>大量数据同时到来的处理效率</span></strong><span>，必须得</span><strong><span>周期性地生成水位线</span></strong><span>，解决方法是保存一下之前所有数据的最大时间戳，需要插入水位线时，就直接以它为时间戳生成新的水位线。</span></p><p><span>		</span><span>如何正确处理“迟到”的数据：用当前已有数据最大时间戳减去延迟时间比如2秒，就是要插入的水位线的时间戳</span></p><p><span>		</span><span>水位线 = 观察到的最大事件时间 - 最大延迟时间 - 1毫秒</span></p><h5 id='314水位线的特性'><span>3.1.4水位线的特性？</span></h5><ul><li><span>水位线是插入到数据流中的一个标记， 可以认为是一个特殊的数据</span></li><li><span>水位线主要的内容是一个时间戳，用来表示当前事件时间的进展</span></li><li><span>水位线是基于数据的时间戳生成的</span></li><li><span>水位线的时间戳必须单调递增，以确保任务的事件时间时钟一直向前推进</span></li><li><span>水位线可以通过设置延迟，来保证正确处理乱序数据</span></li><li><span>一个水位线 Watermark(t)， 表示在当前流中事件时间已经达到了时间戳 t, 这代表 t 之前的所有数据都到齐了，之后流中不会出现时间戳 t’ ≤ t 的数据</span></li></ul><h5 id='315-水位线是如何传递的'><span>3.1.5 水位线是如何传递的？</span></h5><p><span>		</span><span>如果下游有多个并发子任务：当前水位线，广播给所有的下游子任务</span></p><p><span>		</span><span>重分区的传输模式，一个任务有可能会收到来自不同分区上游子任务的数据，取上游子任务最小水位线</span></p><h5 id='316-如何生成水位线'><span>3.1.6 如何生成水位线？</span></h5><p><span>		</span><span>.assignTimestampsAndWatermarks()，主要用来为流中的数据分配时间戳，并生成水位线来指示事件时间。传入一个WatermarkStrategy作为参数，这就是所谓的“水位线生成策略”</span></p><p><span>WatermarkStrategy：</span></p><ul><li><p><span>TimestmpAssiger：主要负责从流中数据元素的某个字段中提取时间戳，并分配给元素。时间戳的分配是生成水位线的基础。</span></p></li><li><p><span>WaterMarkGenerator：基于时间戳生成水位线</span></p><ul><li><span>onEvent() ：每个事件数据到来都会调用的方法，它的参数有当前事件、时间戳</span></li><li><span>onPeriodicEmit()：周期性调用的方法，可以由WatermarkOutput()发出水位线，周期时间为处理时间，可以调用环境配置的.setAutoWatermarkInterval()方法来设置，默认为200ms。</span></li></ul></li></ul><p><span>Flink内置水位线生成器：</span></p><p><strong><span>有序流：WatermarkStrategy.</span><Event><span>forMonotonousTimestamps()</span></strong></p><p><strong><span>乱序流：WatermarkStrategy.</span><Event><span>forBoundedOutOfOrderness()</span></strong></p><h3 id='32-窗口'><span>3.2 窗口</span></h3><h5 id='321-窗口的理解'><span>3.2.1 窗口的理解</span></h5><p><span>		</span><span>把窗口理解成一个“桶”，窗口可以把流切割成有限大小的多个“存储桶（bucket）”；每个数据都会分发到对应的桶中，当到达窗口结束时间时，就对每个桶中收集的数据进行计算处理。</span></p><p><span>		</span><span>Flink中窗口并不是静态准备的，而是动态创建，当有落在这个窗口区间范围的数据到达时，才创建对应的窗口。到达窗口结束时间时，窗口就触发计算并关闭。</span></p><h5 id='322-窗口分类都有哪些窗口'><span>3.2.2 窗口分类，都有哪些窗口</span></h5><p><span>（1）按照驱动类型分类：以什么标准来开始和结束数据的截取</span></p><ul><li><span>时间窗口：按照时间段截取数据</span></li><li><span>计算窗口：按照固定个数，来截取一段数据集</span></li></ul><p><span>（2）按照窗口分配数据的规则分类</span></p><ul><li><p><span>滚动窗口（Tumbling Window）</span></p><p><span>滚动窗口有固定大小，是一种对数据进行“均匀切片”的划分方式。窗口之间没有重叠，也不会有间隔，是“首尾相接”的状态。</span></p><p><span>可以基于时间定义，也可以基于数据定义；需要的参数只有一个，就是窗口大小（window size）</span></p></li><li><p><span>滑动窗口（Sliding Window）</span></p><p><span>滑动窗口的大小也是固定的，窗口之间并不是首尾相接的，而是可以“错开”一定的位置</span></p><p><span>定义滑动窗口有2个参数：窗口大小（window size）、滑动步长（window slide）</span></p></li><li><p><span>会话窗口（Session Window）</span></p><p><span>基于“会话”session来对数据进行分组的。数据来了之后就开启一个会话窗口，如果接下来还有数据陆续到来，那么就一直保持会话；如果一段时间一直没收到数据，那就认为会话超时失效，窗口自动关闭。</span></p></li><li><p><span>全局窗口（Global Window）</span></p><p><span>把相同key的所有数据分配到同一个窗口中，说直白一点，就跟没分窗口一样。无界流的数据永无止尽，所以这种窗口也没有结束的时候，默认是不会做触发计算的。如果希望它能对数据进行计算处理，还需要自定义“触发器”（Trigger）。</span></p></li></ul><h5 id='323-迟到的数据的处理'><span>3.2.3 迟到的数据的处理</span></h5><p><span>（1）设置水位线延迟时间</span></p><p><span>		</span><span>水位线是整个应用的全局逻辑时钟。水位线生产之后，会随着数据在任务间流动，从而给每个任务指明当前事件时间。水位线的延迟主要是用来对付分布式网络传输导致的数据乱序，而网络传输的乱序程度一般不会很大，大多集中在几毫秒～几百毫秒，一般设置毫秒～秒级</span></p><p><span>（2）允许窗口处理迟到数据</span></p><p><span>		</span><span>大部分乱序数据已经被水位线的延迟等到了，所以往往迟到的数据不会太多。在水位线到达窗口结束时间时，先快速输出一个近似正确计算结果；然后保持窗口继续等待到延迟数据，每来一条数据，窗口就会再次计算，并将更新后的结果输出。这样可以逐步修改计算结果，最终得到准确的统计值</span></p><p><span>（3）将迟到数据放入窗口侧输出流</span></p><p><span>		</span><span>用窗口的侧输出流来收集关窗以后的迟到数据，将之前的窗口计算结果保存下来，然后获取侧输出流中的迟到数据，判断数据所属窗口，手动对结果进行合并更新。</span></p><h5 id='324-水位线是如何传递的'><span>3.2.4 水位线是如何传递的？</span></h5><p><span>		</span><span>如何理解flink的watermark，当水位线涨到window 的 endTime时，如果后续还有数据过来，窗口还会继续被触发吗？</span></p><p><span>		</span><span>当水位线到达窗口结束时间时，窗口就会闭合不再接收迟到的数据，因为根据水位线的定义，所有小于等于水位线的数据都已经到达，所以显然Flink会认为窗口中的数据都到达了（尽管可能存在迟到数据，也就是时间戳小于当前水位线的数据）</span><span>	</span></p><h5 id='325-海量key去重'><span>3.2.5 海量Key去重</span></h5><p><span>		</span><span>怎么去重？考虑一个实时场景：双十一场景，滑动窗口长度为 1 小时，滑动距离为 10 秒钟，亿级用户，怎样计算 UV？</span></p><p><span>		</span><span>使用set数据结构或者redis的set显然不行的，因为可能有上亿个key，内存放不下。可以考虑布隆过滤器（Bloom Filter）来去重。</span></p><p><span>		</span><span>布隆过滤器的原理：当一个元素被加入集合时，通过K个散列函数将这个元素映射成一个位数组的K个点，把它们置为1。检索时，只要看这些点是不是都是1就大约知道集合中有没有它了，如果这些点有任何一个0，则被捡元素一点不在，如果都是1，则被捡元素很可能在。</span></p><p><span>		</span></p><p>&nbsp;</p><h2 id='4多流转换'><span>4.多流转换</span></h2><h2 id='5-状态编程'><span>5. 状态编程</span></h2><h3 id='51-状态机制'><span>5.1 状态机制</span></h3><h5 id='511-说一下flink状态机制'><span>5.1.1 说一下Flink状态机制？</span></h5><p><span>		</span><span>Flink内置的很多算子，包括source，sink都是有状态的。在Flink中，状态始终与特定算子相关联。Flink会以checkpoint的形式对各个任务的状态进行快照，用于保证故障恢复时的状态一致性。</span></p><h5 id='512-什么是状态'><span>5.1.2 什么是状态？</span></h5><p><span>		</span><span>每个任务进行计算处理时，可以基于当前数据直接转换得到输出结果；也可以依赖一些其他数据。这些由一个任务维护，并且用来计算输出结果的所有数据，就叫做这个任务的状态。</span></p><p><span>		</span><span>算子任务可以分为无状态和有状态，无状态算子，如map、filter、flatMap，计算时不依赖其他数据。</span></p><p><span>		</span><span>有状态算子，如sum，需要保存之前所有数据的和</span></p><h5 id='513-有状态算子一般处理流程'><span>5.1.3 有状态算子一般处理流程</span></h5><ol start='' ><li><span>算子任务接收到上游发来的数据</span></li><li><span>获取当前状态</span></li><li><span>根据业务逻辑进行计算，更新状态</span></li><li><span>得到计算结果，输出发送到下游任务</span></li></ol><h5 id='514-状态分类'><span>5.1.4 状态分类</span></h5><ul><li><p><span>托管状态（Managed State）</span></p><p><span>由Flink统一管理，状态的存储访问、故障恢复和重组等一系列问题都由Flink实现</span></p><ul><li><p><span>算子状态（Operator State）</span></p><p><span>状态作用范围限定为当前的算子任务实例，也就是只对当前并行子任务实例有效</span></p><p><span>（1）列表状态（ListState）</span></p><p><span>（2）联合列表状态（UnionListState）</span></p><p><span>（3）广播状态（BroadcastState）</span></p></li><li><p><span>按键分区状态</span></p><p><span>状态是根据输入流中定义的键（key）来维护和访问的，所以只能定义在按键分区流（KeyedStream）中，也就keyBy之后才可以使用</span></p><p><span>（1）值状态（ValueState）</span></p><p><span>（2）列表状态（ListState）</span></p><p><span>（3）映射状态（MapState）</span></p><p><span>（4）归约状态（ReducingState）</span></p><p><span>（5）聚合状态（AggregatingState）</span></p></li></ul></li><li><p><span>原始状态（Raw State）</span></p><p><span>自定义，开辟一块内存，自己管理，实现状态的序列化和故障恢复</span></p></li></ul><p>&nbsp;</p><h2 id='6容错机制'><span>6.容错机制</span></h2><h3 id='61-checkpoint机制'><span>6.1 Checkpoint机制</span></h3><h5 id='611-什么是checkpoint'><span>6.1.1 什么是checkpoint</span></h5><p><span>		</span><span>Flink为了达到容错和exactly-once语义的功能，定期将state持久化下来，这个过程叫做checkpoint，它是flink job在某一个时刻全局状态的快照。</span></p><h5 id='612-如何实现一个分布式系统的全局状态保留功能'><span>6.1.2 如何实现一个分布式系统的全局状态保留功能</span></h5><p><span>		</span><span>checkpoint在flink中引入了Barrier流，定时向数据流中发送Barrier（分界线）。</span></p><p><strong><span>实例分析：</span></strong></p><p><span>举例一个简单的ETL过程：</span></p><p><span>		</span><span>source、trans、sink三个算子，source和sink都是kafka，operator之间没有chaining，通过forward strategy分组</span></p><ol start='' ><li><span>数据从kafka中抽过来</span></li><li><span>进行一个trans的转换操作</span></li><li><span>再发送到一个下游的kafka</span></li><li><span>当设置parallism=2时</span></li></ol><p><strong><span>Checkpoint分析过程：</span></strong></p><p><img src="../image/interview/Flink/checkpoint过程.png" referrerpolicy="no-referrer" alt="image-20221129110448363"></p><p><span>		</span><span>每个Flink作业都会产生一个JobManager，JobManager里面又会有一个checkpoint coordinator来管理整个checkpoint的过程，可以设置一个时间间隔让checkpoint coordinator将一个checkpoint的事件发送给每一个Container中的source task，也就是第一个任务。</span></p><p><span>		</span><span>当某个source算子收到一个barrier时，暂停自身的数据处理，将自己的当前state制作成snapshot（快照），并保存到指定的持久化存储中，最后向checkpoint coordinator异步发送一个ack（acknowledge character）确认字符，同时向自身所有下游算子广播该barrier后恢复自身的数据。</span></p><p><span>		</span><span>每个算子按照上面不断制作snapshot并向下游广播，直到最后barrier传递到sink算子，此时快照便制作完成。</span></p><p><span>需要注意：上游算子可能是多个数据源，对应多个barrier，需要全部到齐才一次性触发checkpoint，即对齐。所以在遇到checkpoint时间较长的情况时，有可能是因为数据对齐需要消费的事件比较长所造成的。</span></p><h5 id='613-flink中exactly-once和at-least-once-checkpoint的时候有什么区别'><span>6.1.3 Flink中exactly once和at least once checkpoint的时候有什么区别</span></h5><ul><li><p><span>exactly once（精准一次）Barrier对齐</span></p><p><span>在多并行度下，同一时间可以来源于多个不同快照的多个barrier分界线，如果想要实现精准一次性，需要使用barrier对齐，以便当前快照能够包含消费多个输入流barrier之前（但不超过）的所有envents而产生的状态。</span></p><p><img src="../image/interview/Flink/barrier对齐1.png" referrerpolicy="no-referrer" alt="image-20221208134531778"></p><p><span>上游有两个并行度，中间都被source task插入了barrier，目的地是下游的map task。</span></p><p><img src="../image/interview/Flink/barrier对齐2.png" referrerpolicy="no-referrer" alt="image-20221208134639620"></p><p><span>随着数据的流动，source1的barrier已经进入Map中，此时因为规则是barrier对齐，map需要等待source2的barrier也到达，才可以做快照。并且为了保证barrier可以划分出明确的前后两部分，在等待source2的barrier到来的过程中，source1流到map的数据不会被处理，先放到一个缓存区内，等到barrier对齐之后，再把他们读出来处理。</span></p></li><li><p><span>at least once（至少一次） Barrier不对齐</span></p><p><span>在恢复故障时，需要使用最新的、完整的checkpoint，如果不用等对齐，就可以向下流动，这个时候要是恢复故障，因为barrier id=n不完整，这个checkpoint不可用，要用之前的完整的checkpoint，存在重复处理的数据。</span></p></li></ul><h5 id='614-checkpoint制作的snapshot快照存储方式有哪些'><span>6.1.4 checkpoint制作的snapshot快照存储方式有哪些？</span></h5><p><span>		</span><span>Flink主要提供了2中检查的存储方式：</span></p><ul><li><p><span>JobManagerCheckpointStorage作业管理器的堆内存</span></p><p><span>默认情况，检查点存储在JobManager的堆（heap）内存中。</span></p></li><li><p><span>FileSystemCheckpointStorage文件系统</span></p></li></ul><p><span>检查点配置可以使用.setCheckpointStrorage()来设置</span></p><p>&nbsp;</p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 配置存储检查点到JobManager堆内存</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">env</span>.<span class="cm-variable">getCheckpointConfig</span>().<span class="cm-variable">setCheckpointStorage</span>(<span class="cm-keyword">new</span> <span class="cm-variable">JobManagerCheckpointStorage</span>());</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 配置存储检查点到文件系统</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">env</span>.<span class="cm-variable">getCheckpointConfig</span>().<span class="cm-variable">setCheckpointStorage</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FileSystemCheckpointStorage</span>(<span class="cm-string">"hdsf://namenode:40010/flink/checkpoints"</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="height: 154px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><h5 id='615-checkpoint相关配置'><span>6.1.5 checkpoint相关配置</span></h5><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>19</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">StreamExecutionEnvironment</span> <span class="cm-variable">env</span> <span class="cm-operator">=</span> <span class="cm-variable">StreamExecutionEnvironment</span>.<span class="cm-variable">getExecutionEnvironment</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 启动检查点，间隔时间1秒</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">env</span>.<span class="cm-variable">enableCheckpointing</span>(<span class="cm-number">1000</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Checkpoint</span> <span class="cm-variable">checkpointConfig</span> <span class="cm-operator">=</span> <span class="cm-variable">env</span>.<span class="cm-variable">getCheckpointConfig</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 设置精确一次模式</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">setCheckpointMode</span>(<span class="cm-variable">CheckpointingMode</span>.<span class="cm-variable">EXACTLY_ONCE</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 最小间隔时间500毫秒，最快等多久可以发出保存下一个检查点的指令</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">setMinPauseBetweenCheckpoints</span>(<span class="cm-number">500</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 超时时间1分钟，超时没完成就会被丢弃掉</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">setCheckpointTimeout</span>(<span class="cm-number">60000</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 同时只能有一个检查点</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">setMaxConcurrentCheckpoints</span>(<span class="cm-number">1</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 开启检查点的外部持久化保存，作业取消后依然保留</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">chcekpointConfig</span>.<span class="cm-variable">enableExternalizedCheckpoints</span>(<span class="cm-variable">ExternalizedCheckpointCleanup</span>.<span class="cm-variable">RERAIN_ON_CANCELLATION</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 启用不对齐的检查点保存方式</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">enableUnlignedCheckpoints</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 设置检查点存储，可以直接穿入一个string，指定文件系统的路径</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">checkpointConfig</span>.<span class="cm-variable">setCheckpointStorage</span>(<span class="cm-string">"hdfs://my/checkpoint/dir"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="height: 462px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h5 id='616-从检查点恢复状态的具体步骤'><span>6.1.6 从检查点恢复状态的具体步骤？</span></h5><ol start='' ><li><p><span>重启应用</span></p><p><span>遇到故障之后，第一步就是重启。应用重启后，所有任务的状态会清空</span></p></li><li><p><span>读取检查点，重置状态</span></p><p><span>找到最近一次保存的检查点，从中读取出每个算子任务状态的快照，分别填充到对应的状态中</span></p></li><li><p><span>重放数据</span></p><p><span>如果直接继续处理数据，那么保存检查点之后、到发生故障这段时间内的数据，就相当于丢掉了；会造成计算结果错误。</span></p><p><span>为了不丢数据，应该从保存检查点后开始重新读取数据，可以通过Source任务向外部数据源 重新提交偏移量（offset）来实现。</span></p></li><li><p><span>继续处理数据</span></p></li></ol><h5 id='617-检查点算法---基于chandy-lamport算法的分布式快照'><span>6.1.7 检查点算法—基于Chandy-Lamport算法的分布式快照**</span></h5><p><span>		</span><span>实现的目标是，在不暂停流处理的前提下，让每个任务“认出”触发检查点保存的那个数据。</span></p><p><span>		</span><span>在数据流中插入一个特殊的数据结构（Checkpoint Barrier），专门用来表示触发检查点保存的时间点，收到保存检查点的指令后，Source任务可以在当前数据流中插入这个结构，之后的所有任务只要遇到它就开始对状态做持久化快照保存。</span></p><h5 id='618-分布式快照算法---异步分界线快照asynchronous-barrier-snapshotting）'><span>6.1.8 分布式快照算法—异步分界线快照（asynchronous barrier snapshotting）</span></h5><p><span>		</span><span>算法的核心就是2个原则：当上游任务向多个并行任务发送barrier时，需要广播出去；而多个上游任务向同一个下游任务传递barrier时，需要在下游执行“分界线对齐”（barrier alignment）操作，也就是需要等到所有并行分区的barrier都到齐，才可以开始状态的保存。</span></p><h3 id='62-exactly-onec精确一次'><span>6.2 exactly-onec精确一次</span></h3><h5 id='621-状态一致性状态-exactly-once）'><span>6.2.1 状态一致性（状态 Exactly-once）</span></h5><p><span>		</span><span>对于Flink来说，一致性指的是多个节点并行处理不同的任务，我们要保证计算结果是正确的，就必须不漏掉任何一个数据，而且也不会重复处理同一个数据。</span></p><p><span>		</span><span>exactly-once要求数据不丢，需要有数据重放机制来保证这一点，Flink使用的是一种轻量级快照机制—检查点（checkpoint）来保证exactly-once语义。</span></p><h5 id='622-端到端一致性端到端-exactly---once）'><span>6.2.2 端到端一致性（端到端 Exactly - once）</span></h5><p><span>		</span><span>完整的流处理应用，包括数据源、流处理器和外部存储系统三个部分。</span></p><ul><li><p><span>输入端</span></p><p><span>外部数据源必须拥有重放数据的能力，像Kafka</span></p></li><li><p><span>流处理</span></p><p><span>检查点机制可以保证故障恢复后数据不丢失，并且只处理一次，可以做到exactly-once一致性语义</span></p></li><li><p><span>输出端</span></p><p><span>输出端最大的问题是“覆水难收”，写入到外部系统的数据难以撤回，那怎样可以收回一条写入的数据呢？</span></p><p><span>能够保证exactly-once一致性写入方式有2种：幂等写入和事务写入</span></p><ul><li><p><span>幂等（idempotent）写入</span></p><p><span>一个操作可以重复执行很多次，但只导致一次结果更改，后面再重复执行就不会对结果起作用。</span></p><p><span>Redis中键值存储、Mysql</span></p><p><span>出现短暂不一致</span></p></li><li><p><span>事务（transactional）写入</span></p><p><span>事务是应用程序中一系列严密的操作，所有操作必须成功完成，否则在每个操作中所做的所有更改都会被撤销。事务有4个基本特性：原子性（Atomicity）、一致性（Correspondence）、隔离性（Isolation）、持久性（Durability） ACID</span></p><p><span>当Sink任务遇到barrier时，开始保存状态的同时开启一个事务，接下来所有数据的写入都在这个事务中；待到当前检查点保存完毕时，将事务提交，所有写入的数据就真正可用了。如果中间过程出现故障，状态会回退到上一个检查点，而当前事务没有正常关闭（因为当前检查点没有保存完），所以会回滚，写入到外部的数据就被撤销了</span></p><ul><li><p><span>预写日志（write-ahead-log，WAL）</span></p><p><span>（1）先把结果数据作为日志（log）状态保存起来</span></p><p><span>（2）进行检查点保存时，也会将这些结果数据一并做持久化存储</span></p><p><span>（3）在收到检查点完成的通知时，将所有结果一次性写入外部系统</span></p><p><span>DataStream API提供了一个模板类GenericWriteAheadSink，来实现这种事务型的写入方式</span></p><p><span>缺点：如果检查点已经成功保存、数据也成功地一批写入到外部系统，但是最终保存确认信息时出现故障，Flink最终还是会认为没有成功写入。于是发生故障时，不会使用这个检查点，而是需要回退到上一个，这样就会导致这批数据的重复写入。</span></p></li><li><p><span>两阶段提交（2PC）</span></p><p><span>（1）当第一条数据到来时，或者收到检查点的分界线时，Sink任务都会启动一个事务</span></p><p><span>（2）接下来接收到的所有数据，都通过这个事务写入外部系统；这是由于事务没有提交，所以数据尽管吸入了外部系统，但是不可用，是“预提交”的状态</span></p><p><span>（3）当Sink任务收到JobManager发来检查点完成的通知时，正式提交事务，写入的结果就真正可用了</span></p></li></ul></li></ul></li></ul><h5 id='623-如果下级存储不支持事务flink怎么保证exactly-once'><span>6.2.3 如果下级存储不支持事务，Flink怎么保证exactly-once？</span></h5><p><span>		</span><span>端到端的exactly-one对sink要求比较高，具体实现主要有幂等写入和事务性写入两种方式。密等写入的场景依赖于业务逻辑，更常见的是用事务性写入。而事务性写入又有预写日志（WAL）和两阶段提交（2PC）两种方式。</span></p><p><span>		</span><span>如果外部系统不支持事务，那么可以用预写日志的方式，把结果数据先当成状态保存，然后再收到checkpoint完成通知时，一次性写入sink系统。</span></p><h3 id='63-问题总结'><span>6.3 问题总结</span></h3><h4 id='631-flink作业在很多情况下有可能失败失败之后重新运行时是如何保证数据一致性的'><span>6.3.1 Flink作业在很多情况下有可能失败，失败之后重新运行时，是如何保证数据一致性的？</span></h4><p><span>		</span><span>Flink基于Chandy-Lamport算法，会把分布式的每个节点的状态保存到分布式系统里面作为Checkpoint（检查点），过程大致如下：</span></p><ol start='' ><li><span>从数据源端开始注入Checkpoint Barrier，它是一种比较特殊的信息</span></li><li><span>它会跟普通的事件一样随着数据流去流动，当Barrier到达算子之后，这个算子会把它当前的本地状态进行快照保存，当Barrier流动到Sink，所有的状态都保存完整之后，它就形成一个全局的快照。</span></li><li><span>当作业失败之后，就可以通过远程文件系统里保存的Chenkpoint进行回滚：先把Source会滚到Checkpoint记录的offset，然后把有状态节点当时的状态会滚到对应的事件点，进行重新计算。这样既可以不用从头开始计算，又能保证数据语义的一致性。</span></li></ol><p>&nbsp;</p><p>&nbsp;</p><h2 id='7flink-sql'><span>7.Flink SQL</span></h2><h3 id='71-api'><span>7.1 API</span></h3><p><span>		</span><span>Table API和SQL可以看作联合在一起的一套API，程序处理中，输入数据可以定义成一张表，然后对这张表进行查询，得到新的表，相当于数据流的转换操作。最后定义一张用于输出的表。</span></p><h4 id='711-程序架构'><span>7.1.1 程序架构</span></h4><p><span>程序基本架构：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 创建表环境</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">TableEnvironment tableEnv <span class="cm-operator">=</span> ...<span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 创建输入表，连接外部系统读取数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tableEnv<span class="cm-variable-2">.executeSql</span><span class="cm-bracket">(</span><span class="cm-string">"CREATE TEMPORARY TABLE inputTable ... WITH('connector = ...')"</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 注册一个表，连接到外部系统，用于输出</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tableEnv<span class="cm-variable-2">.executeSql</span><span class="cm-bracket">(</span><span class="cm-string">"CREATE TEMPORARY TABLE outputTable ... WITH('connector = ...')"</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 执行SQL对表进行查询转换，得到一个新的表</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Table</span> table1 <span class="cm-operator">=</span> tableEnv<span class="cm-variable-2">.sqlQuery</span><span class="cm-bracket">(</span><span class="cm-string">"SELECT ... FROM inputTable..."</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 使用Table API对表进行查询转换，得到一个新的表</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Table</span> table2 <span class="cm-operator">=</span> tableEnv<span class="cm-variable-2">.from</span><span class="cm-bracket">(</span><span class="cm-string">"inputTable"</span><span class="cm-bracket">)</span><span class="cm-variable-2">.select</span><span class="cm-bracket">(</span>...<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// 将得到的结果写入输出表</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">TableResult tableResult <span class="cm-operator">=</span> <span class="cm-keyword">table</span><span class="cm-variable-2">.executeInsert</span><span class="cm-bracket">(</span><span class="cm-string">"outputTable"</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="height: 308px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>		</span><span>通过执行DDL直接创建一个表，执行CREATE语句中用WITH指定外部系统的连接器，就可以连接外部系统读取数据了。直接用SQL语句实现全部的流处理过程。</span></p><h4 id='712-表环境tableenvironment'><span>7.1.2 表环境TableEnvironment</span></h4><p><span>		</span><span>Flink在使用Table API和SQL需要一个特别的运行时环境，这就是所谓的“表环境（TableEnvironment）”，它主要负责：</span></p><ol start='' ><li><p><span>注册Catalog和表</span></p><p><span>这里的Catalog就是“目录”，与标准SQL中的概念一致，主要用来管理所有数据库（database）和表（table）的元数据（metadata）。</span></p><p><span>在表环境中可以由用户自定义Catalog，并组册表和自定义函数（UDF）。</span></p></li><li><p><span>执行SQL查询</span></p></li><li><p><span>注册用户自定义函数（UDF）</span></p></li><li><p><span>DataStream和表之间的转换</span></p></li></ol><p><span>使用默认配置创建表环境：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> org<span class="cm-variable-2">.apache.flink.streaming.api.environment.StreamExecutionEnvironment</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> org<span class="cm-variable-2">.apache.flink.table.api.EnvironmentSettings</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> org<span class="cm-variable-2">.apache.flink.table.api.bridge.java.StreamTableEnvironment</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">StreamExecutionEnvironment env <span class="cm-operator">=</span> StreamExecutionEnvironment<span class="cm-variable-2">.getExecutionEnvironment</span><span class="cm-bracket">()</span><span class="cm-punctuation">;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">StreamTableEnvironment tableEnv <span class="cm-operator">=</span> StreamTableEnvironment<span class="cm-variable-2">.create</span><span class="cm-bracket">(</span>env<span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="height: 242px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='713-创建表'><span>7.1.3 创建表</span></h4><p><span>		</span><span>创建表的方式，有连接器（connector）和虚拟表（virtual tables）2种。</span></p><ul><li><p><span>连接器表（Connector Tables）</span></p><p><span>通过连接器（connector）连接到一个外部系统，然后定义出对应的表结构。对表的读写就可以通过连接器转换成对外部系统的读写了。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tableEnv<span class="cm-variable-2">.executeSql</span><span class="cm-bracket">(</span><span class="cm-string">"CREATE [TEMPORARY] TABLE MyTable ... WITH ('connector = ...)"</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="height: 44px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p></li><li><p><span>虚拟表（Virtual Tables）</span></p><p><span>调用表环境的sqlQuery()方法，直接传入一条SQL语句作为参数执行查询，得到一个Table对象。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Table</span> newTable <span class="cm-operator">=</span> tableEnv<span class="cm-variable-2">.sqlQuery</span><span class="cm-bracket">(</span><span class="cm-string">"SELECT ... FROM MyTable..."</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="height: 22px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>得到的newTable是一个中间转换结果，如果希望直接使用这个表执行SQL，需要将这个中间结果表注册到环境中。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tableEnv</span>.<span class="cm-variable">createTemporaryView</span>(<span class="cm-string">"NewTable"</span>, <span class="cm-variable">newTable</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="height: 22px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p></li></ul><h4 id='714-表和流转换'><span>7.1.4 表和流转换</span></h4><ul><li><p><span>将表转换成流（Table—&gt;DataStream）</span></p><ul><li><p><span>调用toDataStream()方法</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tableEnv</span>.<span class="cm-variable">toDataStrem</span>(<span class="cm-variable">visitTable</span>).<span class="cm-variable">print</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="height: 22px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p></li><li><p><span>调用toChangelogStream()方法</span></p><p><span>对于有更新操作的表，进行打印输出，会抛出TableException异常，因为print本身可以看作一个Sink操作，打印输出的Sink操作不支持数据进行更新。解决方法是不要转换成DataStream打印输出，而是记录它的“更新日志”（change log），变成一条更新日志的流，就可以打印输出了。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tableEnv</span>.<span class="cm-variable">toChangelogStream</span>(<span class="cm-variable">urlContTable</span>).<span class="cm-variable">print</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="height: 22px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p></li></ul></li><li><p><span>将流转换成表（DataStream—&gt;Table）</span></p><ul><li><p><span>调用fromDataStream()方法</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Table</span> <span class="cm-variable">eventTable</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">fromDataStream</span>(<span class="cm-variable">eventStream</span>, <span class="cm-variable">$</span>(<span class="cm-string">"timestamp"</span>).<span class="cm-variable">as</span>(<span class="cm-string">"ts"</span>), <span class="cm-variable">$</span>(<span class="cm-string">"url"</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="height: 44px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>由于流中的数据本身就是定义好的POJP类型Event，将流转换成表之后，每一行数据就对应着一个Event，而表中的列名就对应着Event中的属性。</span></p></li><li><p><span>调用createTemporaryView()方法</span></p><p><span>如果希望直接在SQL中引用这张表，可以调用createTemporaryView()方法来创建虚拟视图</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tableEnv</span>.<span class="cm-variable">createTemporaryView</span>(<span class="cm-string">"EventTable"</span>, <span class="cm-variable">eventStream</span>, <span class="cm-variable">$</span>(<span class="cm-string">"timestamp"</span>).<span class="cm-variable">as</span>(<span class="cm-string">"ts"</span>), <span class="cm-variable">$</span>(<span class="cm-string">"url"</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="height: 44px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre></li><li><p><span>调用fromChangelogStream()方法</span></p><p><span>将一个更新日志流转换成表。</span></p></li></ul></li></ul><h4 id='715-支持的数据类型'><span>7.1.5 支持的数据类型</span></h4><p><span>		</span><span>DataStream中支持的数据类型，Table也都支持</span></p><ul><li><p><span>原子类型</span></p><p><span>Integer、Double、String</span></p><p><span>原子类型不做重命名时，默认的字段名“f0”，将原子类型看作了一元组Tuple1的处理结果。</span></p></li><li><p><span>Tuple类型</span></p><p><span>表中字段默认是元组中元素的属性名f0、f1、f2...</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 将数据流转换成只包含 f1 字段的表</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Table</span> <span class="cm-variable">table</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">fromDataStream</span>(<span class="cm-variable">stream</span>, <span class="cm-variable">$</span>(<span class="cm-string">"f1"</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 将数据流转换成包含 f0 和 f1 字段的表，在表中 f0 和 f1 位置交换</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Table</span> <span class="cm-variable">table</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">fromDataStream</span>(<span class="cm-variable">stream</span>, <span class="cm-variable">$</span>(<span class="cm-string">"f1"</span>), <span class="cm-variable">$</span>(<span class="cm-string">"f0"</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 将f1 字段命名为 myInt， f0 命名为 myLong</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Table</span> <span class="cm-variable">table</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">fromDataStream</span>(<span class="cm-variable">stream</span>, <span class="cm-variable">$</span>(<span class="cm-string">"f1"</span>).<span class="cm-variable">as</span>(<span class="cm-string">"myInt"</span>),</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">$</span>(<span class="cm-string">"f0"</span>).<span class="cm-variable">as</span>(<span class="cm-string">"myLong"</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="height: 176px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre></li><li><p><span>POJO类型</span></p><p><span>将 POJO 类型的 DataStream 转换成 Table，如果不指定字段名称，就会直接使用原始 POJO</span>
<span>类型中的字段名称</span></p></li><li><p><span>Row类型</span></p><p><span>Row 类型也是一种复合类型，它的长度固定，而且无法直接推断出每个字段的类型，所以在使用时必须指明具体的类型信息</span></p><p><span>创建 Table 时调用的 CREATE语句就会将所有的字段名称和类型指定，这在 Flink 中被称为表的“模式结构”（ Schema）。除此之外， Row 类型还附加了一个属性 RowKind，用来表示当前行在更新操作中的类型。这样，Row 就可以用来表示更新日志流（ changelog stream）中的数据。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DataStream</span><span class="cm-operator">&lt;</span><span class="cm-variable">Row</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dataStream</span> <span class="cm-operator">=</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">env</span>.<span class="cm-variable">fromElements</span>(</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Row</span>.<span class="cm-variable">ofKind</span>(<span class="cm-variable">RowKind</span>.<span class="cm-variable">INSERT</span>, <span class="cm-string">"Alice"</span>, <span class="cm-number">12</span>),</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Row</span>.<span class="cm-variable">ofKind</span>(<span class="cm-variable">RowKind</span>.<span class="cm-variable">INSERT</span>, <span class="cm-string">"Bob"</span>, <span class="cm-number">5</span>),</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Row</span>.<span class="cm-variable">ofKind</span>(<span class="cm-variable">RowKind</span>.<span class="cm-variable">UPDATE_BEFORE</span>, <span class="cm-string">"Alice"</span>, <span class="cm-number">12</span>),</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Row</span>.<span class="cm-variable">ofKind</span>(<span class="cm-variable">RowKind</span>.<span class="cm-variable">UPDATE_AFTER</span>, <span class="cm-string">"Alice"</span>, <span class="cm-number">100</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 将更新日志流转换为表</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Table</span> <span class="cm-variable">table</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">fromChangelogStream</span>(<span class="cm-variable">dataStream</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="height: 176px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre></li></ul><h3 id='72-流处理中的表'><span>7.2 流处理中的表</span></h3><h3 id='73-时间属性和窗口'><span>7.3 时间属性和窗口</span></h3><h4 id='731-时间'><span>7.3.1 时间</span></h4><h4 id='732-窗口'><span>7.3.2 窗口</span></h4><h5 id='7321-窗口表值函数windowing-tvfs新版本）'><span>7.3.2.1 窗口表值函数（Windowing TVFs，新版本）</span></h5><p><span>		</span><span>从1.13版本开始，Flink开始使用窗口表值函数（Windowing table-valued functions，Windowing TVFs）来定义窗口。</span></p><p><span>	</span><span>目前Flink提供了以下几个窗口TVF：</span></p><ul><li><p><span>滚动窗口（Tumbling Windows）</span></p><p><span>长度固定、时间对齐、无重叠的窗口，一般用于周期性的统计计算</span></p><p><span>TUMBLE(TABLE EventTable, DESCRIPTOR(ts), INTERVAL &#39;1&#39; HOUR)</span></p></li><li><p><span>滑动窗口（Hop Windows，跳跃窗口）</span></p><p><span>设置滑动步长来控制统计输出的频率</span></p><p><span>HOP(TABLE EventTable, DESCRIPTOR(ts), INTERVAL &#39;5&#39; MINUTES, INTERVAL &#39;1&#39; HOURS)</span></p><p><span>基于时间属性ts，在表EventTable上创建了大小为1小时的滑动窗口，每5分钟滑动一次。</span></p></li><li><p><span>累积窗口（Cumulate Windows）</span></p><p><span>场景：统计周期较长，希望中间每隔一段时间就输出一次当前的统计值；与滑动窗口不同的是，在一个统计周期内，会多次输出统计值，应该是不断叠加累积的。</span></p><p><span>例如：按天统计网站的PV，每隔1小时输出一次当天到目前为止的PV值。</span></p><p><span>CUMULATE(TABLE EventTable,DESCRIPTOR(ts), INTERVAL &#39;1&#39; HOURS, INTERVAL &#39;1&#39; DAYS)</span></p><p><span>两个核心参数：最大窗口长度（max window size）和累积步长（step）</span></p></li><li><p><span>会话窗口（Session Windows，目前尚未完全支持）</span></p></li></ul><h3 id='74-聚合'><span>7.4 聚合</span></h3><h4 id='741-窗口聚合'><span>7.4.1 窗口聚合</span></h4><p><span>		</span><span>使用窗口TVF实现分组窗口的聚合：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-keyword">user</span><span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; window_end <span class="cm-keyword">as</span> endT<span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">count</span><span class="cm-bracket">(</span>url<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> cnt</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-keyword">TABLE</span><span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>TUMBLE<span class="cm-bracket">(</span><span class="cm-keyword">TABLE</span> EventTable<span class="cm-punctuation">,</span> DESCRIPTOR<span class="cm-bracket">(</span>ts<span class="cm-bracket">)</span><span class="cm-punctuation">,</span> <span class="cm-keyword">INTERVAL</span> <span class="cm-string">'1'</span> HOUR<span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">group</span> <span class="cm-keyword">by</span> <span class="cm-keyword">user</span><span class="cm-punctuation">,</span> window_start<span class="cm-punctuation">,</span> window_end</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="height: 154px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>		</span><span>以ts作为时间属性字段、基于EventTable定义了1小时的滚动窗口，统计出每小时每个用户点击url的次数。分组字段是用户名user，表示窗口的window_start、window_end</span></p><h4 id='742-开窗聚合'><span>7.4.2 开窗聚合</span></h4><p><span>		</span><span>具体实例：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-keyword">user</span><span class="cm-punctuation">,</span> ts<span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">count</span><span class="cm-bracket">(</span>url<span class="cm-bracket">)</span> over<span class="cm-bracket">(</span><span class="cm-keyword">partition</span> <span class="cm-keyword">by</span> <span class="cm-keyword">user</span> <span class="cm-keyword">order</span> <span class="cm-keyword">by</span> ts <span class="cm-keyword">range</span> <span class="cm-keyword">between</span> <span class="cm-keyword">interval</span> <span class="cm-string">'1'</span> HOUR preceding <span class="cm-keyword">and</span> <span class="cm-keyword">current</span> <span class="cm-keyword">row</span><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> cnt</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> EventTable</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="height: 88px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>		</span><span>以ts作为时间属性字段，对EventTable中的每行数据都选取它之前1小时的所有数据进行聚合，统计每个用户访问url的总次数，并重命名为cnt。</span></p><p><span>		</span><span>使用window字句在select外部单独定义一个over窗口：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-keyword">user</span><span class="cm-punctuation">,</span> ts<span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">count</span><span class="cm-bracket">(</span>url<span class="cm-bracket">)</span> over w <span class="cm-keyword">as</span> cnt<span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">max</span><span class="cm-bracket">(</span>char_length<span class="cm-bracket">(</span>url<span class="cm-bracket">))</span> over w <span class="cm-keyword">as</span> max_url</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> EventTable</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">window w <span class="cm-keyword">as</span><span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">partition</span> <span class="cm-keyword">by</span> <span class="cm-keyword">user</span> <span class="cm-keyword">order</span> <span class="cm-keyword">by</span> ts rows <span class="cm-keyword">between</span> <span class="cm-number">2</span> preceding <span class="cm-keyword">and</span> <span class="cm-keyword">current</span> <span class="cm-keyword">row</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="height: 176px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>		</span><span>定义了选取前2行数据的over窗口，并重命名为w；接下来可以基于它调用多个聚合函数，扩展出更多的列提取出来。</span></p><h4 id='743-窗口topn'><span>7.4.3 窗口TopN</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>15</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">select</span> <span class="cm-operator">*</span><span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; row_number<span class="cm-bracket">()</span> over<span class="cm-bracket">(</span><span class="cm-keyword">partition</span> <span class="cm-keyword">by</span> window_start<span class="cm-punctuation">,</span> window_end <span class="cm-keyword">order</span> <span class="cm-keyword">by</span> cnt <span class="cm-keyword">desc</span><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> row_num</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">from</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">select</span> window_start<span class="cm-punctuation">,</span> window_end<span class="cm-punctuation">,</span> <span class="cm-keyword">user</span><span class="cm-punctuation">,</span> <span class="cm-keyword">count</span><span class="cm-bracket">(</span>url<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> cnt</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">from</span> <span class="cm-keyword">TABLE</span><span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  tumble<span class="cm-bracket">(</span><span class="cm-keyword">table</span> EventTable<span class="cm-punctuation">,</span> descriptor<span class="cm-bracket">(</span>ts<span class="cm-bracket">)</span><span class="cm-punctuation">,</span> <span class="cm-keyword">interval</span> <span class="cm-string">'1'</span> hour<span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">group</span> <span class="cm-keyword">by</span> window_start<span class="cm-punctuation">,</span> window_end<span class="cm-punctuation">,</span> <span class="cm-keyword">user</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> t</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> t</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">where</span> row_num <span class="cm-operator">&lt;=</span> <span class="cm-number">2</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="height: 352px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p>&nbsp;</p><h3 id='75-join'><span>7.5 Join</span></h3><p><span>		</span><span>Flink双流Join主要分为两大类，一类是基于原生State的Connect算子操作，另一类是基于窗口Join操作。其中给予窗口的Join可细分为Window join 和Interval join两种。</span></p><h4 id='751-双流joinregular-join）'><span>7.5.1 双流Join（Regular Join）</span></h4><p><img src="../image/interview/Flink/双流Join.png" alt="image-20221223100459744" style="zoom:50%;" /></p><p><span>		</span><span>Join机制实现原理：依赖Flink的State状态存储，通过将数据存储到State中进行关联join，最终输出结果。</span></p><ul><li><p><span>支持Inner join、left join、right join、full outer join</span></p></li><li><p><span>语法，语义均和传统SQL一致</span></p></li><li><p><span>左右流都会触发结果更新</span></p></li><li><p><span>状态持续增长，一般结合state TTL使用</span></p><p><span>configuration.setString(&quot;table.exec.state.ttl&quot;, &quot;1h&quot;)</span></p></li></ul><h4 id='752-window-join'><span>7.5.2 Window Join</span></h4><p><span>		</span><span>利用Flink的窗口机制实现双流Join，将两条实时流中元素分配到同一个时间窗口中完成Join。</span></p><p><span>		</span><span>底层原理：两条实时流数据缓存在Window State中，当窗口触发计算时，执行join操作</span></p><p><img src="../image/interview/Flink/window join.png" alt="image-20221223102958304" style="zoom:50%;" /></p><p>&nbsp;</p><h4 id='752-区间joininterval-join）'><span>7.5.2 区间Join（Interval Join）</span></h4><h4 id='753-时态表-jointemproal-join）'><span>7.5.3 时态表 Join（Temproal Join）</span></h4><h4 id='754-自定义函数-udtf'><span>7.5.4 自定义函数 UDTF</span></h4><p>&nbsp;</p><h2 id='8压测与监控'><span>8.压测与监控</span></h2><h3 id='81-flink反压机制'><span>8.1 Flink反压机制</span></h3><h4 id='811-flink数据交换'><span>8.1.1 Flink数据交换</span></h4><p><span>		</span><span>Flink的数据交换有3种：</span></p><ul><li><p><span>同一个Task的数据交换</span></p><p><span>通过算子链operator chain串联多个算子，主要作用是避免序列化和网络通信的开销。</span></p><p><span>算子链operator chain串联多个算子的条件：</span></p><ul><li><span>上下游的并行度一致</span></li><li><span>下游节点的入度为1</span></li><li><span>上下游节点共享同一个slot</span></li><li><span>下游节点的chain策略为ALWAYS（例如map、flatmap、filter等默认是ALWAYS）</span></li><li><span>上游节点chain策略为ALWAYS或HEAD（source默认是HEAD）</span></li><li><span>两个节点间数据分区方式是forward</span></li><li><span>用户没有禁用chain</span></li></ul></li><li><p><span>不同Task同JVM下的数据交换</span></p><p><img src="../image/interview/Flink/数据交换2.png" alt="image-20221214160200029" style="zoom:50%;" /></p><p><span>在TaskA中，算子输出的数据首先通过record Writer进行序列化，然后传递给result Partition。接着，数据通过local channel传递给TaskB的input Gate，然后传递给record reader进行反序列。</span></p></li><li><p><span>不同Task且不同TaskManager之间的交换</span></p><p><img src="../image/interview/Flink/数据交换3.png" alt="image-20221214160501095" style="zoom:50%;" /></p><p><span>与上述2不同点是数据先传递给netty，通过netty把数据推送到远程段的task。</span></p></li></ul><h4 id='812-flink的credit-based反压机制'><span>8.1.2 Flink的Credit-based反压机制</span></h4><p><span>		</span><span>在Flink层面实现反压机制，通过ResultPartition和InputGate传输feedback。</span></p><p><span>		</span><span>Credit-base的feedback步骤：</span></p><ul><li><p><span>每一次ResultPartition向InputGate发送数据的时候，都会发送一个backlog size告诉下游准备发送多少消息，下游就会计算游多少Buffer去接收消息。（backlog的作用是为了让消费端感知到我们生产端的情况）</span></p></li><li><p><span>如果下游有充足的Buffer，就会返还给上游Credit（表示剩余buffer数量），告知发送消息（图上两个虚线是采用Netty和Socket进行通信）。</span></p><p><img src="../image/interview/Flink/反压机制1.png" alt="image-20221214161511881" style="zoom:50%;" /></p><p><span>													</span><span>                  生成段发送backlog = 1</span></p><p><img src="../image/interview/Flink/反压机制2.png" alt="image-20221214161616471" style="zoom:50%;" /></p><p><span>																</span><span>消费端返回credit = 3</span></p><p><img src="../image/interview/Flink/反压机制3.JPG" alt="image-20221214161734831" style="zoom:100%;" /></p><p><span>                                                           当生产端用完buffer， 返回credit = 0</span></p><p><img src="../image/interview/Flink/反压机制4.png" alt="image-20221214161836295" style="zoom:50%;" /></p><p>&nbsp;</p><p><span>																</span><span>生产端也出现了数据积压</span></p></li></ul><h5 id='81-怎么做压力测试和监控'><span>8.1 怎么做压力测试和监控？</span></h5><p><span>		</span><span>一般碰到的压力来自以下几个方面：</span></p><ol start='' ><li><span>产生数据流速度如果过快，而下游的算子消费不过来的话，会产生</span><strong><span>背压</span></strong><span>。背压的监控可以使用Flink Web UI来可视化监控，一旦报警就能知道。一般情况下背压问题的产生可能是由于sink这个操作符没有优化好，做一下优化就可以，比如如果写入ElasticSearch，那么可以改成批量写入，可以调大ElasticSearch队列的大小等策略。</span></li><li><span>设置watermark的最大延迟时间这个参数，如果设置的过大，可能会造成内存的压力。可以设置最大延迟时间小一些，然后把迟到元素发送到侧输出流中去。晚一点更新结果。或者使用类似RocksDB这样的状态后端，RocksDB会开辟堆外存储空间，但IO速度会变慢，需要权衡。</span></li><li><span>还有就是滑动窗口的长度如果过长，而滑动距离很短的话，Flink的性能会下降的很厉害。主要通过时间分片的方法，将每个元素只存入一个“重叠窗口”，这样可以减少窗口处理中状态的写入。</span></li></ol><h2 id='9-实时数仓'><span>9. 实时数仓</span></h2><h3 id='91-事实数仓案例'><span>9.1 事实数仓案例</span></h3><h4 id='911-菜鸟仓配实时数据仓库'><span>9.1.1 菜鸟仓配实时数据仓库</span></h4><p>&nbsp;</p><p><strong><span>1.实时数仓的架构是什么样的？</span></strong></p><p><span>		</span><span>实时数仓采用Lambda架构，相对比于Kappa架构，他的优点是灵活性高、容错性高、成熟度高和迁移成本低；缺点是实时、离线数据用两套代码，可能存在一个口径修改了，另一个没改的问题</span></p><p><span>		</span><span>实时计算引擎采用Flink，Flink具有Exactly-once的准确性、轻量级Checkpoint容错机制、低延时高吞吐和易用性高的特点。</span></p><p><span>		</span><span>实时存储引擎采用的redis，ClickHouse是比较好的选择，实时存储引擎要求有维度索引、支持高并发、预聚合、高性能事实多维OLAP查询。</span></p><p><span>1.事实数仓是如何建设的，都有哪些数据</span></p><p>&nbsp;</p><p><span>Flink SQL维表关联</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><span>从0-1处理过多少亿级别的数据 具备设计、调优能力，数据治理</span></p><p><span>实时</span>
<span>1.整体设计</span></p><p><span>数据应用：实时大屏、实时运营、推荐系统</span>
<span>数据服务层：日志服务SLS、Redis</span>
<span>数据计算：Flink</span>
<span>数据模型：dwd实时明细层、dwm轻度汇总层、dws高度汇总层</span></p><p><span>业务系统、埋点数据</span></p><p><span>2.数据模型</span>
<span>实时明细层</span>
<span>   数据清洗</span>
<span>   多流join</span>
<span>   解决方案：数据延迟如何解决</span>
<span>   输出实时明细数据到kafka</span></p><p><span>   实时计算主要是订阅业务消息队列SLS，通过数据清洗ETL，多流join，多数据源join，流式实时数据和静态离线维度数据进行关联组合，将一些相同粒度的业务系统 维度表中维度属性全部关联在一起，做维度退化，增加数据的易用性和服用性，最终得到实时明细数据，将这些数据分成两个分支，一个分支落到CK，支持明细查询使用，一个分支发送到消息队列SLS中供下一层使用</span></p><p><span>汇总层：（实时计算）</span>
<span>  轻度汇总层：轻度汇总数据落地到olap引擎，做报表 clickhouse</span>
<span>  高度汇总层：高度汇总层落地供KV查询的大屏</span></p><p>&nbsp;</p><p><span>3.数据保障能力 灾难备份能力</span></p><p><span>正常链路：业务系统——&gt;消息队列——&gt;实时计算——&gt;数据应用</span></p><p><span>压测链路：              ——&gt;消息队列——&gt;实时计算——&gt;数据应用</span></p><p><span>   消息队列：压缩时间，构造峰值数据</span></p><p><span>	</span><span>实时计算：作业代码 Job任务 复制</span></p><p><span>	</span><span>压测目的：测试产出实时计算在该场景下资源配置</span></p><p><span>主备链路：业务系统——&gt;消息队列——&gt;实时计算——&gt;数据存储——&gt;数据应用</span></p><p><span>灾备链路：                                                  实时计算——&gt;数据存储——&gt;数据应用</span></p><p><span>目的：主链路出现问题，备链路提供服务，针对高优先级的job</span></p><p><span>4.离线数仓和实时数仓的区别</span></p><p>&nbsp;</p><h2 id='10-性能优化'><span>10. 性能优化</span></h2><h3 id='101-数据倾斜'><span>10.1 数据倾斜</span></h3><h4 id='1011-原理'><span>10.1.1 原理</span></h4><p><span>		</span><span>产生数据倾斜的原因主要有2方面：</span></p><ul><li><p><span>业务上有严重的数据热点</span></p><p><span>比如滴滴打车的订单数据中北京、上海等几个城市的订单远远超过其他地区</span></p></li><li><p><span>技术上大量使用KeyBy、GroupBy等操作</span></p><p><span>错误的使用了分组Key，人为产生数据热点</span></p></li></ul><p><span>		</span><span>分组聚合使用KeyGroupStreamPartitioner分区策略，Flink中，就是把一个作业切分成子任务Task，partition将不同的数据交给不同的Task计算。会将数据按照key的Hash值输出到下游算子实例中。</span></p><p><img src="../image/interview/Flink/数据倾斜原理.png" alt="image-20221214110957866" style="zoom:50%;" /></p><h4 id='1012-数据倾斜的影响'><span>10.1.2 数据倾斜的影响</span></h4><ol start='' ><li><p><span>单点问题</span></p><p><span>数据集中在某些分区上（subtask），导致数据严重不平衡</span></p></li><li><p><span>GC频繁</span></p><p><span>过多的数据集中在某些JVM（TaskManager），使得JVM的内存资源短缺，导致频繁GC</span></p></li><li><p><span>吞吐下降、延迟增大</span></p><p><span>数据单点和频繁GC导致吞吐下降、延迟增大</span></p></li><li><p><span>系统崩溃</span></p><p><span>严重情况下，过长的GC导致TaskManager失联，系统崩溃。</span></p></li></ol><h4 id='1013-如何定位数据倾斜'><span>10.1.3 如何定位数据倾斜</span></h4><p><span>步骤1：定位反压</span></p><p><span>		</span><span>定位反压有2种方式：Flink Web UI自带的反压监控（直接方式）、Flink Task Metrics（间接方式）</span></p><p><span>		</span><span>通过监控反压的信息，可以获取到数据处理瓶颈的subtask。</span></p><p><span>步骤2：确定数据倾斜</span></p><p><span>		</span><span>Flink Web UI自带subtask接收和发送的数据量。当subtask之间处理的数据量有较大的差距，则该subtask出现数据倾斜。如下图所示，红框的subtask出现数据热点。</span></p><p><img src="../image/interview/Flink/数据倾斜stubtask.png" referrerpolicy="no-referrer" alt="img"></p><h4 id='1014-解决方法'><span>10.1.4 解决方法</span></h4><p><span>		</span><span>不同场景出现的数据倾斜，使用不同的解决方案</span></p><h5 id='10141-keyby-之前发生数据倾斜'><span>10.1.4.1 keyBy 之前发生数据倾斜</span></h5><p><span>		</span><span>如果keyBy之前就存在数据倾斜，上游算子的某些实例可能处理的数据较多，某些实例可能处理的数据较少，产生该情况可能是因为数据源的数据本身就不均匀。</span></p><p><span>		</span><strong><span>场景：</span></strong><span>Flink消费kafka上下游并行度不一致导致的数据倾斜</span></p><p><span>		</span><strong><span>解决思路：</span></strong><span>需要让Flink任务强制进行shuffle。使用shuffle、rebalance或rescale算子即可将数据均匀分配。</span></p><p><span>通过调整并发度，解决数据源消费不均匀或者数据源反压的情况。调整并发度的原则：KafkaSource并发度与kafka分区数一样的，或者kafka分区数是KafkaSource并发度的整数倍。</span></p><p><span>		</span><span>但是会有一种情况，为了加快数据的处理速度，来设置Flink消费者的并行度大于kafka的分区数。如果不做任何的设置会导致部分Flink Consumer线程永远消费不到数据，需要设置redistributing，也就是数据重分配。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dataStream</span>.<span class="cm-variable">setParallelism</span>(<span class="cm-number">2</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">rebalance</span>() <span class="cm-comment">// .rescale()</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">print</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">setParallelism</span>(<span class="cm-number">4</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="height: 88px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>		</span><span>其中，Rebalance分区策略，数据会以round-robin的方式对数据进行再次分区，可以全局负载均衡。Rescale分区策略基于上下游并行度，会将数据以循环的方式输出到下游的每个实例中。</span></p><h5 id='10142-keyby后的聚会操作存在数据倾斜'><span>10.1.4.2 keyBy后的聚会操作存在数据倾斜</span></h5><p><strong><span>1.为什么不能直接用二次聚合来处理</span></strong></p><p><span>		</span><span>Flink是实时流处理，如果keyBy之后的聚合操作存在数据倾斜，且没有开窗口（没攒批）的情况下，简单的认为使用两阶段聚合，是不能解决问题的。因为这个时候Flink是来一条处理一条，且向下游发送一条结果，对原来keyBy的维度（第二阶段聚合）来讲，数据并没有减少，且结果重复计算。</span></p><p><span>		</span><img src="../image/interview/Flink/数据倾斜keyBy后聚合操作.png" referrerpolicy="no-referrer" alt="image-20221219151226825"></p><p><strong><span>2.使用LocalKeyBy的思想</span></strong></p><p><span>		</span><span>在keyBy上游算子数据发送之前，首先在上游算子的本地对数据进行聚合后，再发送到下游，使下游接收到的数据量大大减少，从而使得keyBy之后的聚合操作不再是任务的瓶颈。类似MapReduce中Combiner的思想，</span><strong><span>但是这要求聚合操作必须是多条数据或者一批数据才能聚合，单条数据没有办法通过聚合来减少数据量</span></strong><span>。从Flink LocalKeyBy实现原理来讲，必然会存在一个</span><strong><span>积攒批次</span></strong><span>的过程，在上游算子中必须攒够一定的数据量，对这些数据聚合后再发送到下游。</span></p><p><span>实现方式：SQL可以指定参数，开启miniBatch和LocalGlobal功能</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 初始化table environment</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TableEnvironment</span> <span class="cm-variable">env</span> <span class="cm-operator">=</span> ...</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取 tableEnv的配置对象</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Configuration</span> <span class="cm-variable">conf</span> <span class="cm-operator">=</span> <span class="cm-variable">env</span>.<span class="cm-variable">getConfig</span>().<span class="cm-variable">getConfiguation</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 设置参数：</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 开启miniBatch</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.enabled"</span>, <span class="cm-string">"true"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 批量输出的间隔时间</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.allow-latency"</span>, <span class="cm-string">"5s"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 防止OOM设置每个批次最多缓存数据的条数，可以设置为2万条</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.size"</span>, <span class="cm-string">"20000"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 开启LocalGlobal</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.optimizer.agg-phase-strategy"</span>, <span class="cm-string">"TWO_PHASE"</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="height: 286px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p>&nbsp;</p><h5 id='10143keyby后的窗口聚合操作存在数据倾斜'><span>10.1.4.3keyBy后的窗口聚合操作存在数据倾斜</span></h5><p><span>		</span><span>因为使用了窗口，变成了有届数据（攒批）的处理，窗口默认是触发时才会输出一条结果发往下游，所以可以使用两阶段聚合的方式：</span></p><p><strong><span>实现思路：</span></strong></p><ul><li><p><span>第一阶段聚合：key拼接随机数前缀或后缀，进行keyBy、开窗、聚合</span></p><p><span>注意：聚合完不再是windowedStream，要获取WindowEnd作为窗口标记作为第二阶段分组依据，避免不同窗口的结果聚合到一起。</span></p></li><li><p><span>第二阶段聚合：按照原来的key及windowEnd作keyBy、聚合</span></p></li></ul><p><span>		</span><span>举例：统计一个网站各个端的每分钟的pv</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>15</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 最内层，讲分组的key，也就是plat加上一个随机打散</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> winEnd<span class="cm-punctuation">,</span>split_index<span class="cm-bracket">(</span>plat1<span class="cm-punctuation">,</span> <span class="cm-string">'_'</span><span class="cm-punctuation">,</span> <span class="cm-number">0</span><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> plat2<span class="cm-punctuation">,</span> <span class="cm-keyword">sum</span><span class="cm-bracket">(</span>pv<span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">select</span> TUMBLE_END<span class="cm-bracket">(</span>proc_time<span class="cm-punctuation">,</span> <span class="cm-keyword">INTERVAL</span> <span class="cm-string">'1'</span> MINUTE<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> winEnd<span class="cm-punctuation">,</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; plat1<span class="cm-punctuation">,</span> <span class="cm-keyword">count</span><span class="cm-bracket">(</span><span class="cm-number">1</span><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> pv</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">from</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-bracket">(</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">select</span> plat <span class="cm-operator">||</span> <span class="cm-string">'_'</span> <span class="cm-operator">||</span> cast<span class="cm-bracket">(</span>cast<span class="cm-bracket">(</span>RAND<span class="cm-bracket">()</span> <span class="cm-operator">*</span> <span class="cm-number">100</span> <span class="cm-keyword">as</span> <span class="cm-type">int</span><span class="cm-bracket">)</span><span class="cm-keyword">as</span> string<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> plat1<span class="cm-punctuation">,</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proc_time</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">from</span> source_kafka_table</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-bracket">)</span> <span class="cm-keyword">as</span> t</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">group</span> <span class="cm-keyword">by</span> TUMBLE<span class="cm-bracket">(</span>proc_time. <span class="cm-keyword">INTERVAL</span> <span class="cm-string">'1'</span> MINUTE<span class="cm-bracket">)</span><span class="cm-punctuation">,</span> plat1</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">)</span> <span class="cm-keyword">as</span> t</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">group</span> <span class="cm-keyword">by</span> winEnd<span class="cm-punctuation">,</span>split_index<span class="cm-bracket">(</span>plat1<span class="cm-punctuation">,</span> <span class="cm-string">'_'</span><span class="cm-punctuation">,</span> <span class="cm-number">0</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="height: 352px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">env</span>.<span class="cm-variable">addSource</span>(<span class="cm-keyword">new</span> <span class="cm-variable">CustomBeanSource</span>()).<span class="cm-variable">keyBy</span>(<span class="cm-variable">ele</span> <span class="cm-operator">-&gt;</span> <span class="cm-variable">ele</span>.<span class="cm-variable">getDeviceName</span>() <span class="cm-operator">+</span> <span class="cm-string">"-"</span> <span class="cm-operator">+</span> <span class="cm-keyword">new</span> <span class="cm-variable">Random</span>().<span class="cm-variable">nextInt</span>(<span class="cm-number">10</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">timeWindow</span>(<span class="cm-variable">Time</span>.<span class="cm-variable">secons</span>(<span class="cm-number">60</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">sum</span>(<span class="cm-string">"bandWidth"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">keyBy</span>(<span class="cm-variable">ele</span> <span class="cm-operator">-&gt;</span> <span class="cm-variable">ele</span>.<span class="cm-variable">getDeviceName</span>())</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">sum</span>(<span class="cm-string">"bandWidth"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-variable">addSink</span>(...)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="height: 154px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>		</span></p><h3 id='102-并行度设置'><span>10.2 并行度设置</span></h3><h4 id='1021-全局并行度计算'><span>10.2.1 全局并行度计算</span></h4><p><span>		</span><span>开发完成后，先进行压测。任务并行度给10个以下，测试单个并行度的处理上限。</span></p><p><strong><span>总QPS / 单并行度的处理能力 = 并行度</span></strong></p><p><span>		</span><span>开发完Flink作业，压测的方式很简单，先在kafka中积压数据，之后开启flink任务，出现反压，就是处理瓶颈。相当于水库先积水，一下子泄洪。</span></p><p><span>		</span><span>不能只从QPS去得出并行度，因为有些字段少、逻辑简单的任务，单并行度一秒处理几万条数据。而有些数据字段多，处理逻辑复杂，单并行度一秒只能处理1000条数据。</span></p><p><span>		</span><span>最好根据高峰期QPS压测，并行度 x 1.2倍，富余一些资源。</span><span>	</span></p><p>&nbsp;</p><h3 id='103-flink-sql优化'><span>10.3 Flink SQL优化</span></h3><h4 id='1031-设置空闲状态保留时间'><span>10.3.1 设置空闲状态保留时间</span></h4><p><span>		</span><span>忘记设置空闲状态保留时间导致状态爆炸，列举两个场景：</span></p><ul><li><span>FlinkSQL 的regular join（inner、left、right），左右表的数据都会一直保存在状态里，不会清理！要么设置TTL，要么使用FlinkSQL的interval join</span></li><li><span>使用Top-N语法进行去重，重复数据的出现一般都位于特定区间内（例如一个小时或一天内），过了这段时间之后，对应的状态就不再需要了。</span></li></ul><p><span>Flink SQL可以指定空闲状态（即未更新的状态）被保留的最小时间，当状态中某个key对应的状态未更新的时间达到阈值时，该条状态被自动清理：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 35px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 27px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27px; width: 27px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// API 指定</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">tableEnv</span>.<span class="cm-variable">getConfig</span>().<span class="cm-variable">setIdleStateRetention</span>(<span class="cm-variable">Duration</span>.<span class="cm-variable">ofHours</span>(<span class="cm-number">1</span>));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 参数指定</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 18px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Configuration</span> <span class="cm-variable">configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">tableEnv</span>.<span class="cm-variable">getConfig</span>().<span class="cm-variable">getConfiguration</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 18px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">configuration</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.state.ttl"</span>, <span class="cm-string">"1h"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="height: 132px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='1032-开启minibatch'><span>10.3.2 开启MiniBatch</span></h4><p><span>		</span><span>MiniBatch是微批处理，原理是缓存一定的数据后再触发处理，以减少对State的访问，从而提升吞吐并减少数据的输出量。Minibatch主要依靠在每个Task上注册的Timer线程来触发微批，需要消耗一定的线程调度性能。</span></p><p><strong><span>开启方式：</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -36px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 初始化table environment</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">TableEnvironment</span> <span class="cm-variable">env</span> <span class="cm-operator">=</span> ...</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取tableEnv的配置对象</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Configuration</span> <span class="cm-variable">conf</span> <span class="cm-operator">=</span> <span class="cm-variable">env</span>.<span class="cm-variable">getConfig</span>().<span class="cm-variable">getConfiguration</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 设置参数：</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 开启MiniBatch</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.enabled"</span>, <span class="cm-string">"true"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 批量输出的间隔时间</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.allow-latency"</span>, <span class="cm-string">"5s"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 防止OOM设置每个批次最多缓存数据的条数，可以设为2万条</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">conf</span>.<span class="cm-variable">setString</span>(<span class="cm-string">"table.exec.mini-batch.size"</span>, <span class="cm-string">"20000"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -36px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="height: 264px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><strong><span>使用场景：</span></strong></p><p><span>		</span><span>微批处理通过增加延迟换取高吞吐，如果有超低延迟的要求，不建议开启微批处理。通常对于聚合的场景，微批处理可以显著提升系统性能，建议开启。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div></div>
</body>
</html>